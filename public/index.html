<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Readraa - Wisdom in Minutes: Discover, read, and interact with concise PDF summaries of books. Gain valuable insights in minutes.">
  <meta name="keywords" content="Readraa, PDF summaries, book summaries, knowledge, learning, concise books, wisdom, self-help, finance, psychology">
  <title>Readraa - Wisdom in Minutes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Google Analytics Placeholder -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_TRACKING_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'YOUR_GA_TRACKING_ID');
  </script>
  <!-- End Google Analytics Placeholder -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* (Full CSS from user; minified here for brevity) */
:root{--primary-color:#4e54c8;--secondary-color:#8f94fb;--text-color:#333;--bg-color:#f9f9f9;--card-bg:#ffffff;--shadow:0 4px 12px rgba(0,0,0,.1);--transition:all .3s ease}.dark-mode{--primary-color:#6b73ff;--secondary-color:#a2a7ff;--text-color:#f0f0f0;--bg-color:#121212;--card-bg:#1e1e1e;--shadow:0 4px 12px rgba(0,0,0,.3)}*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;transition:var(--transition)}body{background-color:var(--bg-color);color:var(--text-color);min-height:100vh;padding:70px 0 60px 0;opacity:0;animation:fadeIn .5s ease forwards;font-family:'Roboto', sans-serif !important; position: relative;}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.top-nav,.bottom-nav{position:fixed;left:0;right:0;background-color:var(--card-bg);box-shadow:var(--shadow);display:flex;align-items:center;padding:0 10px;z-index:1000}.top-nav{top:0;height:70px;justify-content:space-between}.logo-container{display:flex;flex-direction:column}.logo-main{font-size:32px;font-weight:bold;color:var(--primary-color)}.logo-sub{font-size:10px;color:var(--text-color);margin-top:-4px}.theme-toggle{background:none;border:none;cursor:pointer;font-size:24px;color:var(--text-color);transition:transform .3s ease}.theme-toggle:hover{transform:scale(1.1)}.bottom-nav{bottom:0;height:60px;justify-content:space-around}.nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;background:none;border:none;color:var(--text-color);font-size:12px;cursor:pointer;padding:8px 12px;border-radius:8px;transition:var(--transition)}.nav-btn i{font-size:18px;margin-bottom:4px}.nav-btn.active{color:var(--primary-color);background-color:rgba(78,84,200,.1)}.nav-btn:hover{transform:translateY(-2px)}.page{display:none;}.page.active{display:block;animation:fadeIn .5s ease}.section-title{margin:20px 0 15px;font-size:22px;color:var(--primary-color);position:relative;padding-left:15px}.section-title::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:100%;background-color:var(--primary-color);border-radius:2px}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5)}.modal-content{background-color:var(--bg-color);margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:10px;box-shadow:var(--shadow);position:relative}.close-modal{position:absolute;top:10px;right:15px;color:#aaa;font-size:28px;font-weight:bold;cursor:pointer}.close-modal:hover,.close-modal:focus{color:#333}.dark-mode .close-modal:hover,.dark-mode .close-modal:focus{color:#fff}.auth-container{display:flex;flex-direction:column}.auth-tabs{display:flex;margin-bottom:20px}.auth-tab{flex:1;padding:10px;text-align:center;cursor:pointer;background-color:var(--bg-color);border-bottom:2px solid transparent;color:var(--text-color);font-weight:bold}.auth-tab.active{border-color:var(--primary-color);color:var(--primary-color)}.auth-form{display:none;flex-direction:column}.auth-form.active{display:flex}.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;color:var(--text-color)}.form-group input,.form-group textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;background-color:var(--bg-color);color:var(--text-color)}.auth-btn{background-color:var(--primary-color);color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;transition:background-color .3s}.auth-btn:hover{background-color:var(--secondary-color)}
.edit-profile-btn {
  background-color: var(--primary-color);
  color: #fff;
  padding: 10px 15px;
:root{--primary-color:#4e54c8;--secondary-color:#8f94fb;--text-color:#333;--bg-color:#f9f9f9;--card-bg:#ffffff;--shadow:0 4px 12px rgba(0,0,0,.1);--transition:all .3s ease}.dark-mode{--primary-color:#6b73ff;--secondary-color:#a2a7ff;--text-color:#f0f0f0;--bg-color:#121212;--card-bg:#1e1e1e;--shadow:0 4px 12px rgba(0,0,0,.3)}*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;transition:var(--transition)}body{background-color:var(--bg-color);color:var(--text-color);min-height:100vh;padding:70px 0 60px 0;opacity:0;animation:fadeIn .5s ease forwards;font-family:'Roboto', sans-serif !important; position: relative;}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.top-nav,.bottom-nav{position:fixed;left:0;right:0;background-color:var(--card-bg);box-shadow:var(--shadow);display:flex;align-items:center;padding:0 10px;z-index:1000}.top-nav{top:0;height:70px;justify-content:space-between}.logo-container{display:flex;flex-direction:column}.logo-main{font-size:32px;font-weight:bold;color:var(--primary-color)}.logo-sub{font-size:10px;color:var(--text-color);margin-top:-4px}.theme-toggle{background:none;border:none;cursor:pointer;font-size:24px;color:var(--text-color);transition:transform .3s ease}.theme-toggle:hover{transform:scale(1.1)}.bottom-nav{bottom:0;height:60px;justify-content:space-around}.nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;background:none;border:none;color:var(--text-color);font-size:12px;cursor:pointer;padding:8px 12px;border-radius:8px;transition:var(--transition)}.nav-btn i{font-size:18px;margin-bottom:4px}.nav-btn.active{color:var(--primary-color);background-color:rgba(78,84,200,.1)}.nav-btn:hover{transform:translateY(-2px)}.page{display:none;}.page.active{display:block;animation:fadeIn .5s ease}.section-title{margin:20px 0 15px;font-size:22px;color:var(--primary-color);position:relative;padding-left:15px}.section-title::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);height:24px;width:5px;background-color:var(--primary-color);border-radius:2px}.content-section{padding:10px 15px;margin-bottom:10px}.categories-container,.library-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;padding-bottom:15px}.category,.library-card{background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);padding:15px;text-align:center;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;align-items:center;min-height:180px}.category img,.library-card img{max-width:100%;height:auto;border-radius:8px;margin-bottom:10px}.category h3,.library-card h4{font-size:16px;margin-bottom:5px;color:var(--primary-color)}.category p,.library-card p{font-size:13px;color:var(--text-color);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;margin-bottom:10px}.fav-btn{position:absolute;bottom:10px;right:10px;background:none;border:none;font-size:20px;cursor:pointer;color:#ccc;transition:color .2s;z-index:10}.fav-btn.active{color:#ff6b6b}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4);justify-content:center;align-items:center}.modal.active{display:flex}.modal-content{
  background-color:var(--bg-color);
  margin: 5% auto; /* Adjusted margin to give more vertical space */
  padding:20px;
  border:1px solid #888;
  width:80%;
  max-width: 700px;
  height: auto; /* Allow height to adjust to content */
  max-height: 90vh; /* Set max-height to 90% of viewport height */
  overflow-y: auto; /* Enable vertical scrolling for content */
  border-radius:10px;
  box-shadow:var(--shadow);
  position:relative;
  white-space: normal; /* Ensure text wraps */
}

.modal-body-scrollable {
  max-height: calc(90vh - 100px); /* Adjust as needed based on header/footer height */
  overflow-y: auto;
}

#storyDisplayContent {
  height: 100%; /* Ensure it takes full height of parent */
  overflow-y: auto; /* Enable vertical scrolling */
  overflow-x: hidden; /* Prevent horizontal scrolling */
  white-space: normal; /* Ensure text wraps */
}

#storyDisplayContent {
  height: 100%; /* Ensure it takes full height of parent */
  overflow-y: auto; /* Enable vertical scrolling */
  overflow-x: hidden; /* Prevent horizontal scrolling */
  white-space: normal; /* Ensure text wraps */
}

#storyDisplayContentText {
  max-height: 100%; /* Ensure it takes full height of parent */
  overflow-y: auto; /* Enable vertical scrolling */
  white-space: normal; /* Ensure text wraps */
  word-break: break-word; /* Ensure long words break and wrap */
}.close-modal{position:absolute;top:-11px;right:5px;color:#aaa;font-size:36px;font-weight:bold;cursor:pointer}

.close-modal:hover,.close-modal:focus{color:#333}.dark-mode .close-modal:hover,.dark-mode .close-modal:focus{color:#fff}.auth-container{display:flex;flex-direction:column}.auth-tabs{display:flex;margin-bottom:20px}.auth-tab{flex:1;padding:10px;text-align:center;cursor:pointer;background-color:var(--bg-color);border-bottom:2px solid transparent;color:var(--text-color);font-weight:bold}.auth-tab.active{border-color:var(--primary-color);color:var(--primary-color)}.auth-form{display:none;flex-direction:column}.auth-form.active{display:flex}.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;color:var(--text-color)}.form-group input,.form-group textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;background-color:var(--bg-color);color:var(--text-color)}.auth-btn{background-color:var(--primary-color);color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;transition:background-color .3s}.auth-btn:hover{background-color:var(--secondary-color)}
.auth-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.text-button {
  background: none;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: background-color .3s;
}

.edit-profile-btn:hover {
  background-color: var(--secondary-color);
}.profile-header{display:flex;flex-direction:column;align-items:center;padding:20px;background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);margin-bottom:20px}.profile-avatar{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px}.profile-name{font-size:20px;font-weight:bold;color:var(--primary-color)}.profile-bio{font-size:14px;color:var(--text-color)}.profile-stories{padding:0 15px}.story-card{background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);padding:15px;margin-bottom:15px}.story-card h4{font-size:16px;color:var(--primary-color);margin-bottom:5px}.story-card p{font-size:13px;color:var(--text-color);margin-bottom:10px}.story-author{display:flex;align-items:center}.author-avatar{width:30px;height:30px;border-radius:50%;margin-right:10px}.author-name{font-size:13px;font-weight:bold;color:var(--text-color)}.author-meta{font-size:11px;color:#888}.create-story{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);cursor:pointer;margin-bottom:20px}.create-story i{font-size:40px;color:var(--primary-color);margin-bottom:10px}.create-story p{font-size:16px;font-weight:bold;color:var(--text-color)}.search-bar{display:flex;gap:10px;padding:15px}.search-input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;background-color:var(--bg-color);color:var(--text-color)}.search-btn{background-color:var(--primary-color);color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold}.search-btn:hover{background-color:var(--secondary-color)}.search-categories{display:flex;flex-wrap:wrap;gap:10px;padding:0 15px 15px}.search-category{background-color:var(--card-bg);padding:8px 12px;border-radius:8px;font-size:14px;color:var(--text-color);cursor:pointer}.search-category:hover{background-color:var(--primary-color);color:#fff}.clear-btn{background-color:#f44336;color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold}.clear-btn:hover{background-color:#d32f2f}.library-section{margin-bottom:20px}.library-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;padding:0 15px}.library-card{background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);padding:15px;text-align:center}.library-card h4{font-size:16px;color:var(--primary-color);margin-bottom:5px}.library-card p{font-size:13px;color:var(--text-color)}.fav-btn{background:none;border:none;font-size:20px;cursor:pointer;position:absolute;top:10px;right:10px}.fav-btn.active{color:red}#pdfModal .modal-content{max-width:800px;height:90vh}#pdfContent{width:100%;height:100%;display:flex;flex-direction:column}#pdfContent iframe{flex-grow:1;border:none}.categories-container{display:flex;overflow-x:auto;padding:10px 15px;gap:15px;scrollbar-width:none;-ms-overflow-style:none}.categories-container::-webkit-scrollbar{display:none}.category{flex:0 0 150px;background-color:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);padding:15px;text-align:center;position:relative}.category h3{font-size:16px;color:var(--primary-color);margin-bottom:5px}.category p{font-size:13px;color:var(--text-color)}.animated-emoji{position:fixed;font-size:2rem;animation:floatUp 1s ease-out forwards;pointer-events:none;z-index:9999}@keyframes floatUp{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-250%) scale(1.5);opacity:0}}/* FORCED Horizontal Scrolling Sections */
    #home .categories-container, #library .library-cards {
      display: flex !important;
      flex-direction: row !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      flex-wrap: nowrap !important;
      padding-bottom: 20px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-color);
    }

    /* Scrollbar styling for Webkit browsers */
    .categories-container::-webkit-scrollbar, .library-cards::-webkit-scrollbar {
      height: 8px;
    }
    .categories-container::-webkit-scrollbar-track, .library-cards::-webkit-scrollbar-track {
      background: var(--bg-color);
    }
    .categories-container::-webkit-scrollbar-thumb, .library-cards::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 2px solid var(--bg-color);
    }

    /* Super-Compact PDF Gallery Styles */
    .category, .library-card {
      width: 120px !important;
      height: 120px !important; /* Make it a square */
      min-width: 120px !important;
      max-width: 120px !important;
      min-height: 120px !important;
      max-height: 120px !important;
      margin-right: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center; /* Center the title vertically */
      align-items: center; /* Center the title horizontally */
      padding: 8px; /* Adjusted padding for new size */
      overflow: hidden;
      position: relative;
      text-align: center;
      cursor: pointer; /* Added for pointer on hover */
    }

    .category h3, .library-card h4 {
      font-size: 15px; /* Slightly smaller title */
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 4; /* Allow up to 4 lines for wrapping */
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0; /* Remove margins */
      line-height: 1.3;
      color: #000; /* Force black text for titles in light mode */
    }

    .dark-mode .category h3, .dark-mode .library-card h4 {
      color: var(--text-color); /* Use theme text color for dark mode */
    }

    /* Hide the paragraph text completely for a gallery look */
    .category p, .library-card p {
      display: none;
      color: #000; /* Force black text for paragraphs in light mode */
    }

    .pdf-card-category {
      display: block !important; /* Override the general rule that hides p tags */
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }

    .dark-mode .pdf-card-category {
      color: #aaa;
    }

    .dark-mode .category p, .dark-mode .library-card p {
      color: var(--text-color); /* Use theme text color for dark mode */
    }

    /* Social Section Styling */
    .social-section {
      text-align: center; /* Center text and inline-block elements */
      padding: 20px 0;
      margin-top: auto; /* Push to bottom if parent is flex column */
      width: 100%; /* Ensure it takes full width for centering */
    }

    .social-section p {
      font-size: 1.2em; /* Make text bigger */
      margin-bottom: 15px; /* Space between text and icons */
      color: var(--text-color); /* Use theme text color */
    }

    .social-icons {
      display: flex; /* Use flexbox for icon alignment */
      justify-content: center; /* Center icons horizontally */
      gap: 20px; /* Space between icons */
    }

    .social-icons a {
      transition: color 0.3s ease;
    }

    .social-icons .fa-instagram {
      color: #C13584; /* Instagram brand color */
    }
    .social-icons .fa-instagram:hover {
      color: #833AB4; /* Darker shade on hover */
    }

    .social-icons .fa-facebook {
      color: #1877F2; /* Facebook brand color */
    }
    .social-icons .fa-facebook:hover {
      color: #0D47A1; /* Darker shade on hover */
    }

    .social-icons .fa-x-twitter { /* Updated class for X icon */
      color: #000000; /* X (Twitter) brand color - black */
    }
    .social-icons .fa-x-twitter:hover {
      color: #333333; /* Slightly lighter black on hover */
    }

    .social-icons i {
      font-size: 2.5em; /* Keep icons bigger */
    }

    /* Dark mode adjustments for social icons */
    .dark-mode .social-icons .fa-instagram {
      color: #E1306C; /* Instagram color for dark mode */
    }
    .dark-mode .social-icons .fa-instagram:hover {
      color: #F56040;
    }

    .dark-mode .social-icons .fa-facebook {
      color: #4267B2; /* Facebook color for dark mode */
    }
    .dark-mode .social-icons .fa-facebook:hover {
      color: #365899;
    }

    .dark-mode .social-icons .fa-x-twitter {
      color: #FFFFFF; /* X (Twitter) color for dark mode - white */
    }
    .dark-mode     .social-icons .fa-x-twitter:hover {
      color: #CCCCCC;
    }

    .social-icons .fa-youtube {
      color: #FF0000; /* YouTube brand color */
    }
    .social-icons .fa-youtube:hover {
      color: #CC0000; /* Darker shade on hover */
    }

    .social-icons .fa-snapchat-ghost {
      color: #FFFC00; /* Snapchat brand color */
    }
    .social-icons .fa-snapchat-ghost:hover {
      color: #E6E300; /* Darker shade on hover */
    }

/* Scrolling Banner Styles */
.scrolling-banner-container {
  width: 100%;
  overflow: hidden; /* Hide content outside the container */
  background-color: var(--card-bg);
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.scrolling-banner-content {
  white-space: nowrap; /* Keep content on a single line */
  animation: marquee 30s linear infinite; /* Adjust duration for speed */
  display: inline-block; /* Needed for animation to work with white-space */
}

@keyframes marquee {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}

.about-us-section {
  margin-top: 20px;
  margin-bottom: 20px;
  background-color: var(--card-bg);
  padding: 15px; /* Default padding */
  border-radius: 12px;
  box-shadow: var(--shadow);
  transition: padding 0.3s ease; /* Add transition for smooth padding change */
}

.about-us-section.is-collapsed {
  padding: 5px 15px; /* Further reduced top/bottom padding when collapsed */
}

.about-us-toggle {
  cursor: pointer;
  display: flex;
  justify-content: flex-start; /* Align items to the start */
  align-items: center;
  margin-bottom: 10px; /* Space between title and content */
}

.about-us-toggle i {
  transition: transform 0.3s ease;
  margin-left: 8px; /* Space between text and arrow */
}

.about-us-toggle.active i {
  transform: rotate(180deg); /* Rotate arrow when active */
}

.about-us-content {
  overflow: hidden;
  transition: max-height 0.3s ease-out; /* For smooth collapse/expand */
  max-height: 0; /* Initially hidden */
}
.about-us-content.active {
  max-height: 500px; /* Max height when expanded (adjust as needed) */
}

/* Styles for the stories grid to mimic horizontal scrolling like WhatsApp/Instagram stories */
.stories-grid {
  display: flex;
  flex-direction: column; /* Changed to column for vertical stacking */
  /* flex-wrap: wrap; // Not strictly needed if column */
  gap: 8px; /* Reduced vertical spacing */
  margin-top: 20px;
  overflow-x: hidden; /* No horizontal scrolling */
  overflow-y: auto; /* Keep vertical scrolling if content overflows */
  padding: 20px;
  padding-bottom: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--primary-color) var(--bg-color);
}

/* Webkit scrollbar styles */
.stories-grid::-webkit-scrollbar {
  height: 8px;
}
.stories-grid::-webkit-scrollbar-track {
  background: var(--bg-color);
}
.stories-grid::-webkit-scrollbar-thumb {
  background-color: var(--primary-color);
  border-radius: 10px;
  border: 2px solid var(--bg-color);
}

/* Styles for individual story cards */
.story-card {
  width: 100%;
  height: auto; /* Let height adjust to content */
  min-height: 100px; /* Minimum height for a chat-like entry */
  background-color: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 10px;
  border: 1px solid var(--primary-color);
  display: flex;
  flex-direction: row; /* Changed to row for horizontal arrangement of avatar and content */
  align-items: flex-start; /* Align items to the top */
  text-align: left;
  cursor: pointer;
  transition: transform 0.2s ease;
  position: relative;
  
  margin-right: 0;
  overflow: hidden;
}

.story-author-section {
  display: flex;
  flex-direction: column; /* Stack avatar and details vertically */
  align-items: center;
  margin-right: 10px; /* Space between author section and content */
  flex-shrink: 0; /* Prevent shrinking */
}

.story-content-section {
  flex-grow: 1; /* Take remaining space */
  display: flex;
  flex-direction: column;
  justify-content: center; /* Center content vertically */
}

.story-card .story-content {
  flex-grow: 1; /* Allow content to take available space */
  margin-left: 10px; /* Space between avatar and content */
  display: flex;
  flex-direction: column;
}

.story-card:hover {
  transform: translateY(-5px);
}

.story-card h4 {
  font-size: 1em;
  margin-bottom: 5px;
  color: var(--text-color);
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* Limit title to 2 lines */
  -webkit-box-orient: vertical;
}

.story-card p {
  font-size: 0.8em;
  color: var(--text-color);
  white-space: pre-wrap !important; /* Force preserve whitespace and wrap text */
  overflow-y: auto; /* Enable vertical scrolling for the text content */
  overflow-x: hidden; /* Prevent horizontal scrolling */
  word-break: break-word; /* Ensure long words break and wrap */
  -webkit-line-clamp: unset; /* Remove line clamping */
  display: block; /* Ensure it behaves as a block element */
  text-overflow: unset; /* Remove ellipsis */
  flex-grow: unset; /* Remove flex-grow if it causes issues */
  max-height: unset; /* Allow it to grow within the modal-content */
  margin-bottom: 10px;
}

.story-card .story-author {
  display: flex;
  align-items: center;
  /* margin-top: auto; // Removed, as it's now part of a row flex */
  /* width: 100%; // Removed, as it's now part of a row flex */
  justify-content: flex-start;
  flex-shrink: 0; /* Prevent author section from shrinking */
}

.story-card .author-avatar {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 5px;
}

.story-card .author-details {
  text-align: left;
}

.story-card .author-name {
  font-size: 0.75em;
  font-weight: bold;
  color: var(--primary-color);
}

.story-card .story-meta {
  font-size: 0.65em;
  color: var(--text-color);
}

.story-display-author-info {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.story-display-author-info .author-avatar {
  width: 40px; /* Slightly larger avatar for the modal */
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 10px;
}

.story-display-author-info .author-name {
  font-size: 1.1em;
  font-weight: bold;
  color: var(--primary-color);
}

  /* Theme Selection Popup Styles */
  #themeSelectionPopup .modal-content {
    width: 300px;
    padding: 20px;
    text-align: center;
  }

  #themeSelectionPopup h3 {
    margin-bottom: 20px;
    color: var(--text-color);
  }

  .theme-options {
    display: flex;
    justify-content: space-around;
    gap: 10px;
  }
  .confirm-actions {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
  }
  .confirm-actions button {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: background-color 0.3s;
  }
  #confirmDeleteBtn {
    background-color: #e74c3c; /* A softer red */
    color: #fff;
    border: none;
  }
  #confirmDeleteBtn:hover {
    background-color: #c0392b;
  }
  #cancelDeleteBtn {
    background-color: #a0c4ff; /* A light shade of the primary color */
    color: #fff;
    border: none;
  }
  #cancelDeleteBtn:hover {
    background-color: #8f94fb; /* secondary color */
  }
  .magnifying-glass-bg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px; /* Increased size */
    height: 400px; /* Increased size */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="%23ccc" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zm-160 0c0-44.2-35.8-80-80-80s-80 35.8-80 80s35.8 80 80 80s80-35.8 80-80z"/></svg>');
    background-repeat: no-repeat;
    background-size: contain;
    opacity: 0.3; /* Increased opacity as requested */
    z-index: -1; /* Ensure it's behind other content */
    pointer-events: none; /* Make it non-interactive */
  }
  .delete-story-btn {
  position: static; /* Remove absolute positioning */
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 1.2em;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s ease;
  z-index: 10; /* Ensure it's above other content */
  padding: 0; /* Remove padding from icon buttons */
}

  .delete-story-btn:hover {
    opacity: 1;
    color: red; /* Make it red on hover for delete action */
  }

.edit-story-btn {
  position: static; /* Remove absolute positioning */
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 1.2em;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s ease;
  z-index: 10;
  padding: 0; /* Remove padding from icon buttons */
  margin-right: 10px; /* Add space between edit and delete/publish buttons */
}

.edit-story-btn:hover {
  opacity: 1;
  color: var(--primary-color);
}



.publish-draft-btn {
  position: static; /* Remove absolute positioning */
  background-color: var(--primary-color);
  color: #fff;
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: background-color .3s;
  opacity: 1; /* Ensure publish button is always fully visible */
}

.publish-draft-btn:hover {
  background-color: var(--secondary-color);
}

/* Avatar Editing Styles */
.profile-avatar-container {
  position: relative;
  margin-bottom: 10px;
}

.edit-avatar-btn {
  position: absolute;
  bottom: 0;
  right: 0;
  background-color: var(--primary-color);
  color: white;
  border: 2px solid var(--card-bg);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.edit-avatar-btn:hover {
  transform: scale(1.1);
}

#avatarModal .modal-content {
  max-width: 500px;
}

.avatar-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  max-height: 300px;
  overflow-y: auto;
}

.avatar-option {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 2px solid transparent;
}

.avatar-option:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px var(--primary-color);
}

.upload-section input[type="file"] {
  display: none; /* Hide the default file input */
}

.upload-section .auth-btn {
  display: inline-block;
  margin-top: 10px;
}

.autocomplete-container {
  position: relative;
  display: inline-block;
  width: 100%;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff;
  border-bottom: 1px solid #d4d4d4;
}

.autocomplete-items div:hover {
  background-color: #e9e9e9;
}

.autocomplete-active {
  background-color: DodgerBlue !important;
  color: #ffffff;
}

.search-bar {
  display: flex;
  margin-bottom: 20px;
  position: relative;
}

.search-input {
  flex-grow: 1;
}

.password-container {
  position: relative;
}

.toggle-password {
  position: absolute;
  top: 50%;
  right: 10px;
  transform: translateY(-50%);
  cursor: pointer;
}

.reactions-container {
  position: absolute;
  bottom: 10px;
  left: 10px;
}

.reaction-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.emojis-container {
  display: none;
  position: absolute;
  bottom: 30px;
  left: 0;
  background-color: var(--card-bg);
  border-radius: 20px;
  padding: 5px;
  box-shadow: var(--shadow);
  z-index: 10;
}

.emoji {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  margin: 0 5px;
}

.story-actions {
    position: absolute;
    bottom: 10px;
    right: 80px; /* Adjusted to make space for comment button */
    display: flex;
    gap: 10px; /* Space between buttons */
    /* align-items: center; */ /* Removed as not needed with gap */
}

.story-card .story-content-section .reactions-container {
  position: relative;
  margin-top: 10px;
  bottom: auto;
  left: auto;
}

.reactions-container {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.reaction {
  display: flex;
  align-items: center;
  cursor: pointer;
  filter: grayscale(1);
  transition: filter 0.3s ease;
}

.reaction.reacted {
  filter: grayscale(0);
}

.reaction .emoji {
  font-size: 20px;
}

.reaction .count {
  font-size: 14px;
  margin-left: 5px;
}

.disabled-feature {
  opacity: 0.4;
  cursor: not-allowed;
}

.forgot-password-link.disabled-feature:hover {
  cursor: pointer;
}
  </style>

  <style>
    /* Custom Toast Notification Styles */
    #customToast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      background-color: #333;
      color: white;
      font-size: 14px;
      z-index: 2000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
    }
    #customToast.show {
      visibility: visible;
      opacity: 1;
      bottom: 80px; /* Slide up from bottom */
    }
    #customToast.success {
      background-color: #28a745;
    }
    #customToast.error {
      background-color: #dc3545;
    }
.view-all-container {
  text-align: center;
  margin-top: 15px; /* Adjust as needed for midway positioning */
  margin-bottom: 15px;
}

body.modal-open {
  overflow: hidden;
}

.modal-content {
  display: flex;
  flex-direction: column;
}

  .modal-content .stories-grid {
  flex-grow: 1; /* Allow it to take available vertical space */
  max-height: calc(100vh - 200px); /* Adjust based on header/footer in modal */
  /* You might need to fine-tune this max-height based on actual modal header/footer */
}

  .modal-top-layer {
  z-index: 2000; /* Higher than other modals */
}

.admin-story-border {
  border: 2px solid gold !important; /* Use !important to override existing borders */
}

  .admin-tag {
  font-size: 0.7em; /* Smaller font size */
  color: #888; /* A subtle color */
  /* margin-left: 5px; /* Space from the date */ /* Removed */
}

  .comment-btn {
  position: absolute;
  bottom: 10px;
  right: 10px; /* Adjust as needed to not overlap with edit/delete */
  background: none;
  border: none;
  font-size: 1.2em;
  color: var(--primary-color);
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s ease;
  display: flex;
  align-items: center;
  gap: 5px;
  z-index: 10;
}

.comment-btn:hover {
  opacity: 1;
}

/* Style for the comment count */
.comment-count {
  font-size: 0.8em;
  color: var(--text-color);
}

/* Comment Modal Styles */
#commentModal .modal-content {
  max-width: 600px;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.comments-list {
  flex-grow: 1;
  overflow-y: auto;
  max-height: 400px; /* Adjust as needed */
  margin-bottom: 15px;
  border: 1px solid var(--text-color);
  border-radius: 8px;
  padding: 10px;
}

.comment-item {
  background-color: var(--card-bg); /* Use card background for the box */
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 5px; /* Reduced margin for minimum distance */
  box-shadow: var(--shadow); /* Subtle shadow for depth */
}

.comment-item:last-child {
  border-bottom: none;
}

.comment-item.admin-comment {
  border: 2px solid gold;
  background-color: #fff8dc; /* Light golden background */
}

.dark-mode .comment-item.admin-comment {
  background-color: #3a3a30; /* Darker golden background for dark mode */
}

.comment-author {
  font-weight: bold;
  color: var(--primary-color);
  font-size: 0.9em;
}

.comment-avatar {
  width: 24px; /* Smaller avatar size */
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 8px;
}

.comment-text {
  font-size: 0.9em;
  color: var(--text-color);
  margin-top: 5px;
}

.comment-date {
  font-size: 0.7em;
  color: #888;
  text-align: right;
}

.comment-input-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#commentInput {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background-color: var(--bg-color);
  color: var(--text-color);
  min-height: 30px; /* Decreased height to 30px */
  resize: vertical;
}

#submitCommentBtn {
  align-self: flex-end; /* Align button to the right */
}

  </style>
</head>
<body>
  <noscript>
    <div style="text-align: center; padding: 20px; background-color: #ffdddd; color: #cc0000; font-weight: bold;">
      Please enable JavaScript to use this application.
    </div>
  </noscript>
  <!-- Login/Register Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <span class="close-modal" id="closeAuthModal">&times;</span>
      <div class="auth-container">
        <div class="auth-tabs">
          <div class="auth-tab active" data-tab="login">Login</div>
          <div class="auth-tab" data-tab="register">Register</div>
        </div>

        <form class="auth-form active" id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <div class="password-container">
              <input type="password" id="loginPassword" required onkeydown="return event.key != ' '">
              <i class="fas fa-eye toggle-password"></i>
            </div>
          </div>
          <div class="form-group" style="display: flex; align-items: center; margin-bottom: 15px;">
            <input type="checkbox" id="termsCheckbox" style="margin-right: 10px; width: auto;">
            <label for="termsCheckbox" style="margin-bottom: 0; font-size: 0.9em;">
              I agree to the <a href="/privacy-policy.html" target="_blank" style="color: var(--primary-color); text-decoration: none;">Privacy Policy</a> &amp; <a href="/terms-of-service.html" target="_blank" style="color: var(--primary-color); text-decoration: none;">Terms of Service</a>
            </label>
          </div>
          <button type="submit" class="auth-btn">Login</button>

<p class="forgot-password-link disabled-feature" onclick="showToast('This feature will be added soon.')">Forgot Password?</p>

        </form>

        <form class="auth-form" id="registerForm">
          <div class="form-group">
            <label for="registerName">Full Name</label>

            <input type="text" id="registerName" required onkeydown="return event.key != ' '">

            <input type="text" id="registerName" required onkeydown="if(event.key === ' ') event.preventDefault();">

          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" required onkeydown="if(event.key === ' ') event.preventDefault();">
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <div class="password-container">

              <input type="password" id="registerPassword" required onkeydown="return event.key != ' '">

              <input type="password" id="registerPassword" required onkeydown="if(event.key === ' ') event.preventDefault();">

              <i class="fas fa-eye toggle-password"></i>
            </div>
          </div>
          <div class="form-group">
            <label for="registerConfirmPassword">Confirm Password</label>
            <div class="password-container">
              <input type="password" id="registerConfirmPassword" required onkeydown="return event.key != ' '">
              <i class="fas fa-eye toggle-password"></i>
            </div>
          </div>

          <div class="form-group">
            <label for="registerPhone">Phone Number</label>
            <p style="font-size: 0.8em; color: #888; margin-top: -10px; margin-bottom: 5px;">Optional: Provide your number for easier password recovery.</p>
            <div style="display: flex; gap: 5px; margin-bottom: 15px;">
              <select id="registerPhonePrefix" disabled class="disabled-feature" onclick="showToast('This feature will be added soon.')" style="width: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); z-index: 10;">
                <!-- Options will be populated by JavaScript -->
              </select>
              <input type="tel" id="registerPhone" disabled class="disabled-feature" value="Feature coming soon" onclick="showToast('This feature will be added soon.')" style="flex-grow: 1;">
            </div>
          </div>
          <button type="submit" class="auth-btn">Register</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Top Navigation Bar -->
  <nav class="top-nav">
    <div class="logo-container">
      <div class="logo-main">readraa</div>
      <div class="logo-sub">WISDOM IN MINUTES</div>
    </div>
    <div class="right-nav-buttons">
      <button class="edit-profile-btn" id="openAuthBtn">Login / Register</button>
      <button class="theme-toggle" id="themeToggle">🌙</button>
    </div>
  </nav>

  <!-- Bottom Navigation Bar -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-page="home">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </button>
    <button class="nav-btn" data-page="library">
      <i class="fas fa-book-open"></i>
      <span>Library</span>
    </button>
    <button class="nav-btn" data-page="pencil" id="pencilNavBtn">
      <i class="fas fa-pencil-alt"></i>
      <span>Write</span>
    </button>
    <button class="nav-btn" data-page="search">
      <i class="fas fa-search"></i>
      <span>Search</span>
    </button>
    <button class="nav-btn" data-page="account">
      <i class="fas fa-user"></i>
      <span>Account</span>
    </button>
  </nav>

  <!-- Home Page -->
  <section id="home" class="page active">
    <div class="scrolling-banner-container">
      <div class="scrolling-banner-content">
        <!-- Readra information will go here -->
        <p>Readraa: Wisdom in Minutes - Discover, Read, Interact. Your ultimate PDF library for knowledge and stories. Explore trending topics, connect with authors, and track your reading journey. Accessible anywhere, anytime.</p>
      </div>
    </div>

    <div id="dynamicHomeCategories"></div>

    <div class="about-us-section">
      <h2 class="section-title about-us-toggle" id="aboutUsToggle">About Us <i class="fas fa-chevron-down"></i></h2>
      <div class="about-us-content">
        <!-- About Us text -->
        <p>Readraa is a platform dedicated to making knowledge more accessible by providing concise, well-structured PDF summaries of books. Our summaries are crafted to capture the essence of an entire book, allowing readers to gain valuable insights in just a few minutes.</p>
        <p>We ensure authenticity by basing each summary on the author's complete work, and we express our appreciation by crediting the author on the final page of every PDF. All summaries are protected under copyright, ensuring their originality and safeguarding them from unauthorized use.</p>
        <p>Our mission is to empower lifelong learners by distilling complex information into easily digestible formats, fostering a community passionate about continuous growth and discovery.</p>
      </div>
    </div>

    <div class="social-section">
      <p>Follow us on</p>
      <div class="social-icons">
        <a href="https://www.instagram.com/readraaofficial?igsh=YzljYTk1ODg3Zg==" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://www.youtube.com/@readraa" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://www.snapchat.com/add/readraaofficial" target="_blank"><i class="fab fa-snapchat-ghost"></i></a>
        <a href="https://x.com/readraaofficial" target="_blank"><i class="fab fa-x-twitter"></i></a>
      </div>
      <div class="legal-links">
        <a href="/privacy-policy.html" target="_blank">Privacy Policy</a> | <a href="/terms-of-service.html" target="_blank">Terms of Service</a>
      </div>
    </div>
  </section>

  <!-- Library Page -->
  <section id="library" class="page">
    <h2 class="section-title">Recently Viewed</h2>
    <div class="library-section">
      <div class="library-cards" id="viewedContainer">
        <div class="library-card" onclick="openPdfModal('JavaScript Basics')">
          <h4>JavaScript Basics</h4>
          <p>Last viewed: 2 days ago</p>
        </div>
        <div class="library-card" onclick="openPdfModal('CSS Mastery')">
          <h4>CSS Mastery</h4>
          <p>Last viewed: 1 week ago</p>
        </div>
      </div>
      
    </div>

    <h2 class="section-title">My Favorites</h2>
    <div class="library-section">
      <div class="library-cards" id="favoritesContainer">
        <p>No favorites added yet.please login to add them</p>
      </div>
      
    </div>

    <div id="dynamicLibraryCategories"></div>
  </section>

  <!-- Pencil Page -->
  <section id="pencil" class="page">
    <div class="create-story" onclick="openStoryModal()">
      <i class="fas fa-plus-circle"></i>
      <p>Create a new story</p>
    </div>

    <div class="stories-grid" id="storiesGrid">
      <!-- Stories will be rendered here -->
    </div>
  </section>

  <!-- Search Page -->
  <section id="search" class="page">
    <div class="magnifying-glass-bg"></div> <!-- Added magnifying glass background -->
    <div class="search-container" style="position: relative;">
      <div class="search-bar">
        <input class="search-input" id="searchInput" placeholder="Search for PDFs...">
        <button class="search-btn" id="searchButton">Search</button>
      </div>
      <div id="autocomplete-container" class="autocomplete-container"></div>
    </div>

    
    <div id="searchResultsContainer" class="library-cards">
      <!-- Search results will be rendered here -->

    </div>
  </section>

  <!-- Account Page -->
  <section id="account" class="page">
    <div class="profile-header">
      <div class="profile-avatar-container">
        <img class="profile-avatar" src="https://i.pravatar.cc/100" alt="avatar">
        <button class="edit-avatar-btn" id="editAvatarBtn"><i class="fas fa-camera"></i></button>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
  <div class="profile-name">Guest</div>
  <button type="button" class="text-button" id="editNameBtn" style="font-size: 14px; text-decoration: none; color: var(--text-color);">
    <i class="fas fa-edit"></i>
  </button>
</div>
      <div class="profile-bio">Please login to view profile</div>
    </div>

    <div class="profile-stories">
      <h3>My Stories</h3>
      <div id="myStoriesContainer">
        <p>No stories yet</p>
      </div>
    </div>

    <div class="profile-stories">
      <h3>My Drafts</h3>
      <div id="myDraftsContainer">
        <p>No drafts yet</p>
      </div>
    </div>
  </section>

  <!-- Avatar Selection Modal -->
  <div id="avatarModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeAvatarModal">&times;</span>
      <h3>Choose Your Avatar</h3>
      <div class="avatar-grid" id="avatarGrid">
        <!-- Cartoon avatars will be populated here by JS -->
      </div>
      <div class="upload-section">
        <p>Or upload your own photo:</p>
        <input type="file" id="avatarUpload" accept="image/*">
        <label for="avatarUpload" class="auth-btn">Choose a file</label>
      </div>
    </div>
  </div>

  <!-- Modal placeholder for PDF viewer -->
  <div id="pdfModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closePdfModal()">×</span>
      <div id="pdfContent">
        <h3 id="pdfTitle">PDF Title</h3>
        <p>PDF content preview (placeholder)</p>
        <button id="pdfFavBtn" class="fav-btn" onclick="toggleFavorite(currentPdfTitle, this)">🤍</button>
      </div>
    </div>
  </div>

  <!-- Theme Selection Popup -->
  <div id="themeSelectionPopup" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeThemeSelectionPopup">&times;</span>
      <h3>Choose Theme for PDF</h3>
      <div class="theme-options">
        <button class="action-button" id="lightModeBtn">Light Mode</button>
        <button class="action-button" id="darkModeBtn">Dark Mode</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeDeleteConfirmModal">&times;</span>
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete this story?</p>
      <div class="confirm-actions">
        <button class="action-button" id="cancelDeleteBtn">Cancel</button>
        <button class="action-button" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Story Creation Modal -->
  <div id="storyModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeStoryModal">&times;</span>
      <h2>Create New Story</h2>
      <form id="storyForm">
        <div class="form-group">
          <label for="storyTitle">Title</label>
          <input type="text" id="storyTitle" required>
        </div>
        <div class="form-group">
          <label for="storyContent">Content</label>
          <textarea id="storyContent" rows="10" required></textarea>
        </div>
        <button type="submit" class="auth-btn">Publish Story</button>
        <button type="button" class="auth-btn" id="saveAsDraftBtn" style="background-color: #007bff; margin-top: 10px;">Save as Draft</button>
        <button type="button" class="auth-btn" id="clearDraftBtn" style="background-color: #6c757d; margin-top: 10px;">Clear Draft</button>
        <button type="button" class="auth-btn" id="deleteStoryFromModalBtn" style="background-color: #dc3545; margin-top: 10px; display: none;">Delete</button>
      </form>
    </div>
  </div>

  <!-- Story Display Modal -->
  <div id="storyDisplayModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeStoryDisplayModal()">×</span>
      <div class="modal-body-scrollable"> <!-- New wrapper div -->
        <div id="storyDisplayContent">
          <div class="story-display-author-info">
            <img id="storyDisplayAuthorAvatar" class="author-avatar" alt="Author Avatar">
            <span id="storyDisplayAuthorName" class="author-name"></span>
          </div>
          <h2 id="storyDisplayTitle"></h2>
          <p id="storyDisplayContentText"></p>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Edit Name Modal -->
  <div id="editNameModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeEditNameModal()">&times;</span>
      <h2>Edit Name</h2>
      <form id="editNameForm">
        <div class="form-group">
          <label for="newName">New Name</label>
          <input type="text" id="newName" required onkeydown="return event.key != ' '">
        </div>
        <button type="submit" class="auth-btn">Save Name</button>
      </form>
      <p style="font-size: 12px; color: red; text-align: center; margin-bottom: 5px;">You can change your name three times in every 30 days.</p>
      <p id="nameEditInfo" style="font-size: 12px; color: var(--text-color); margin-top: 10px; text-align: center;"></p>
    </div>
  </div>

  <!-- Name Change Confirmation Modal -->
  <div id="nameConfirmModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeNameConfirmModal()">&times;</span>
      <h2>Confirm Name Change</h2>
      <p style="text-align: center; margin-bottom: 20px;">Are you sure you want to change your name to <strong id="confirmNewNameText"></strong>?</p>
      <div style="display: flex; justify-content: space-around; gap: 10px;">
        <button type="button" class="auth-btn" id="confirmNameChangeBtn">Confirm</button>
        <button type="button" class="auth-btn" id="cancelNameChangeBtn" style="background-color: #8c959d;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const token = () => localStorage.getItem("token"); // Moved to top
    const API_BASE = "/api";


// Call populate function when the DOM is loaded
document.addEventListener("DOMContentLoaded", () => {
  populateCountryCodes("registerPhonePrefix");
  populateCountryCodes("forgotPhonePrefix");
});
    let currentPdfTitle = null;
    let currentPdfFilePath = null; // Keep this for the popup
    let currentPdfActionType = null; // Keep this for the popup
    let allPdfs = []; // Make allPdfs globally accessible

    async function loadInitialData() {
        try {
            const res = await fetch(`${API_BASE}/pdfs`);
            if (!res.ok) throw new Error('Failed to fetch library data');
            const { categories } = await res.json();
            if (categories && categories.length > 0) {
                allPdfs = categories.flatMap(c => c.pdfs);
                console.log("allPdfs array populated with", allPdfs.length, "PDFs.");
            }
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }

    window.addEventListener("load", loadInitialData);

    // --- STORY STORAGE ---
    const getStories = () => JSON.parse(localStorage.getItem('stories')) || [];
    const saveStories = (stories) => localStorage.setItem('stories', JSON.stringify(stories));

    // --- NAVIGATION ---
    document.querySelectorAll(".bottom-nav .nav-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> {
        // Remove any lingering animated emojis from previous reactions
        document.querySelectorAll('.animated-emoji').forEach(el => el.remove()); // Add this line

        document.querySelectorAll(".bottom-nav .nav-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const page = btn.dataset.page;
        document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
        document.getElementById(page).classList.add("active");

        if (page === 'pencil') {
          renderAllStories();
        } else if (page === 'account') {
          loadProfile();
        }
      });
    });

    async function renderAllStories() {
      const storiesGrid = document.getElementById('storiesGrid');
      if (!storiesGrid) return;

      console.log("renderAllStories called."); // Debug log
      try {
        const res = await fetch(`${API_BASE}/stories`);
        if (!res.ok) {
          throw new Error('Failed to fetch stories');
        }
        const data = await res.json();
        let stories = data.stories || [];
        // Sort stories: admin stories first, then by creation date (newest first)
        stories.sort((a, b) => {
          if (a.isAdmin && !b.isAdmin) return -1; // a is admin, b is not, a comes first
          if (!a.isAdmin && b.isAdmin) return 1;  // b is admin, a is not, b comes first
          return new Date(b.createdAt) - new Date(a.createdAt); // Sort by date for non-admins or both admins
        });
        console.log("Fetched stories in renderAllStories:", stories); // Debug log
        saveStories(stories); // Save to localStorage

        const userProfile = JSON.parse(localStorage.getItem('userProfile')); // Get current user profile
        const currentUserId = userProfile ? userProfile.id : null; // Use id as ID
        console.log("Current user ID in renderAllStories:", currentUserId); // Debug log

        const isAccountPage = document.querySelector('#account.active') !== null;
        if (stories.length > 0) {
          storiesGrid.innerHTML = stories.map(story => {
            const isCurrentUserStory = (currentUserId && story.userId === currentUserId);
            console.log(`createStoryCardHtml - Story: ${story.title}, story.userId: ${story.userId}, currentUserId: ${currentUserId}, isCurrentUserStory: ${isCurrentUserStory}, isAdmin: ${userProfile ? userProfile.isAdmin : false}`); // Debug log
            return createStoryCardHtml(story, isCurrentUserStory, userProfile, isAccountPage);
          }).join('');
        } else {
          storiesGrid.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">No stories posted yet.</p>';
        }
      } catch (error) {
        console.error('Error rendering stories:', error);
        storiesGrid.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">Error loading stories.</p>';
      }
    }

    // --- THEME TOGGLE ---
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener("click", ()=> {
      document.documentElement.classList.toggle("dark-mode");
      themeToggle.textContent = document.documentElement.classList.contains("dark-mode") ? "☀️" : "🌙";
    });

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("userProfile");
      loadProfile();
      showToast("You have been logged out.");
    }

    // --- AUTH MODAL ---
    document.getElementById("closeAuthModal").addEventListener("click", () => {
      document.getElementById("authModal").classList.remove("active");
    });
    document.getElementById("openAuthBtn").addEventListener("click", () => {
      console.log("openAuthBtn clicked");
      if (token()) { // If logged in, this button is now "Logout"
        logout();
      } else {
        document.getElementById("authModal").classList.add("active");
        populateCountryCodes("registerPhonePrefix"); // Populate dropdown when auth modal opens
      }
    });

    document.getElementById("editNameBtn").addEventListener("click", () => {
      openEditNameModal();
    });
    document.querySelectorAll(".auth-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".auth-tab, .auth-form").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab + "Form").classList.add("active");
      });
    });

    // --- LOGIN FORM SUBMISSION ---
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      try {
        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.setItem("token", data.token);
          const userProfile = {
            name: data.name,
            email: data.email,
            isAdmin: data.isAdmin,
            id: data.id
          };
          localStorage.setItem("userProfile", JSON.stringify(userProfile));
          showToast("Login successful!");
          document.getElementById("authModal").classList.remove("active");
          loadProfile(); // Update UI with logged-in user
        } else {
          showToast(data.message || "Login failed.", 'error');
        }
      } catch (error) {
        console.error("Login error:", error);
        showToast("An error occurred during login.", 'error');
      }
    });

    // --- TERMS AND PRIVACY CHECKBOX ---
    const termsCheckbox = document.getElementById('termsCheckbox');
    const loginButton = document.querySelector('#loginForm .auth-btn');

    if (loginButton) {
      loginButton.disabled = true; // Initially disable the login button
    }

    if (termsCheckbox && loginButton) {
      termsCheckbox.addEventListener('change', () => {
        loginButton.disabled = !termsCheckbox.checked;
      });
    }

    // --- REGISTER FORM SUBMISSION ---
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      let name = document.getElementById("registerName").value;
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const confirmPassword = document.getElementById("registerConfirmPassword").value;

      // const phonePrefix = document.getElementById("registerPhonePrefix").value; // Get phone prefix
      // const phoneNumber = phonePrefix + document.getElementById("registerPhone").value; // Combine prefix and number

      // Name validation
      console.log("Name input:", name);
      name = name.trim(); // Trim leading/trailing spaces
      console.log("Trimmed name:", name);
      if (name.length < 2 || name.length > 20) {
        showToast("Name must be between 2 and 20 characters long.", 'error');
        return;
      }
      console.log("Validation result:", /^[a-zA-Z\s]+$/.test(name));
      if (!/^[a-zA-Z\s]+$/.test(name)) {
        showToast("Name can only contain letters and spaces.", 'error');
        return;
      }
      if (/\s\s+/.test(name)) { // No consecutive spaces
        showToast("Name cannot contain consecutive spaces.", 'error');

      

      // Name validation
      if (name.includes(' ')|| name.length < 2 || name.length > 20 || !/^[a-zA-Z0-9]+$/.test(name)) {
        showToast("Name must be 2-20 characters, contain no spaces, and only contain letters and numbers.", 'error');

        return;
      }

      // Password validation
      if (password.includes(' ')|| password.length < 5) {
        showToast("Password must be at least 5 characters and contain no spaces.", 'error');

      // Name validation
      if (name.length < 2 || name.length > 15) {
        showToast("Name must be between 2 and 15 characters long.", 'error');
        return;
      }
      if (!/^[a-zA-Z0-9_*\-^!]+$/.test(name)) {
        showToast("Name can only contain letters, numbers, and the following special characters: _ * - ^ !", 'error');
        return;
      }

      if (password.length < 5 || password.length > 20) {
        showToast("Password must be between 5 and 20 characters long.", 'error');
        return;
      }
      if (/\s/.test(password)) { // Check for any whitespace
        showToast("Password cannot contain spaces.", 'error');
        return;
      }
      if (password !== confirmPassword) {
        showToast("Passwords do not match.", 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password }),
        });
        const data = await res.json();
        if (res.ok) {
          showToast("Registration successful! You can now log in.");
          document.querySelector(".auth-tab[data-tab='login']").click();
        } else {
          showToast(data.message || "Registration failed.", 'error');
        }
      } catch (error) {
        console.error("Registration error:", error);
        showToast("An error occurred during registration.", 'error');
      }
    });

    // --- STORY DRAFT PERSISTENCE ---
    const STORY_DRAFT_TITLE_KEY = 'storyDraftTitle';
    const STORY_DRAFT_CONTENT_KEY = 'storyDraftContent';

    function saveStoryDraft() {
      const storyTitleInput = document.getElementById('storyTitle');
      const storyContentInput = document.getElementById('storyContent');
      localStorage.setItem(STORY_DRAFT_TITLE_KEY, storyTitleInput.value);
      localStorage.setItem(STORY_DRAFT_CONTENT_KEY, storyContentInput.value);
    }

    function loadStoryDraft() {
      const storyTitleInput = document.getElementById('storyTitle');
      const storyContentInput = document.getElementById('storyContent');
      const savedTitle = localStorage.getItem(STORY_DRAFT_TITLE_KEY);
      const savedContent = localStorage.getItem(STORY_DRAFT_CONTENT_KEY);

      if (savedTitle) {
        storyTitleInput.value = savedTitle;
      }
      if (savedContent) {
        storyContentInput.value = savedContent;
      }
    }

    function clearStoryDraft() {
      localStorage.removeItem(STORY_DRAFT_TITLE_KEY);
      localStorage.removeItem(STORY_DRAFT_CONTENT_KEY);
      document.getElementById('storyTitle').value = '';
      document.getElementById('storyContent').value = '';
    }

    // --- STORY MODAL & SUBMISSION ---
    function openStoryModal() {
      console.log("openStoryModal called. Token:", token()); // Added log
      if (!token()) {
        showToast("Please log in to create a story.", 'error');
        document.getElementById("authModal").classList.add("active");
        return;
      }
      document.getElementById("storyModal").classList.add("active");
      loadStoryDraft(); // Load draft when modal opens
      document.getElementById('deleteStoryFromModalBtn').style.display = 'none'; // Hide delete button by default
    }

    function closeStoryModal() {
      document.getElementById("storyModal").classList.remove("active");
      document.getElementById("storyModal").classList.remove("modal-top-layer"); // Add this line
      // Do NOT reset form or clear draft here, as user might want to resume
      document.querySelector('#storyModal .auth-btn').textContent = 'Publish Story'; // Reset button text
      editingStoryId = null; // Clear editing state
      document.getElementById('deleteStoryFromModalBtn').style.display = 'none'; // Hide delete button on close
    }
    document.getElementById("closeStoryModal").addEventListener("click", closeStoryModal);

    // Event listeners for draft saving
    document.getElementById('storyTitle').addEventListener('input', saveStoryDraft);
    document.getElementById('storyContent').addEventListener('input', saveStoryDraft);

    // Event listener for Clear Draft button
    document.getElementById('clearDraftBtn').addEventListener('click', clearStoryDraft);

    // Event listener for Save as Draft button
    document.getElementById('saveAsDraftBtn').addEventListener('click', saveAsDraft);

    async function saveAsDraft() {
      const storyTitle = document.getElementById("storyTitle").value;
      const storyContent = document.getElementById("storyContent").value;
      const userProfile = JSON.parse(localStorage.getItem('userProfile'));

      if (!userProfile || !userProfile.id) {
          showToast("Could not identify user. Please log in again.", 'error');
          return;
      }

      try {
          const res = await fetch(`${API_BASE}/stories/draft`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': token()
              },
              body: JSON.stringify({ title: storyTitle, content: storyContent })
          });

          if (res.ok) {
              showToast("Draft saved successfully!");
              clearStoryDraft();
              closeStoryModal();
              loadProfile();
          } else {
              const errorData = await res.json();
              showToast(errorData.message || "Failed to save draft.", 'error');
          }
      } catch (error) {
          console.error("Error saving draft:", error);
          showToast("An error occurred while saving the draft.", 'error');
      }
    }

    function openStoryDisplayModal(storyId) {
      const stories = getStories();
      const story = stories.find(s => s.id === Number(storyId));

      if (story) {
        document.getElementById('storyDisplayTitle').textContent = story.title;
        document.getElementById('storyDisplayAuthorAvatar').src = story.avatarUrl || generateDefaultAvatar(story.author);
        document.getElementById('storyDisplayAuthorName').textContent = `${story.author}`;
        document.getElementById('storyDisplayContentText').textContent = story.content;
        document.getElementById('storyDisplayModal').classList.add('active');
        document.getElementById('storyDisplayModal').classList.add('modal-top-layer'); // Add this line
      }
    }

    function closeStoryDisplayModal() {
      document.getElementById('storyDisplayModal').classList.remove('active');
      document.getElementById('storyDisplayModal').classList.remove('modal-top-layer'); // Add this line
    }

    let currentCommentStoryId = null; // To store the ID of the story whose comments are being viewed

    async function openCommentModal(storyId) {
      if (!token()) {
        showToast("Please log in to comment.", 'error');
        document.getElementById("authModal").classList.add("active");
        return;
      }
      currentCommentStoryId = storyId;
      document.getElementById('commentModal').classList.add('active');
      document.body.classList.add('modal-open'); // Prevent body scroll
      document.getElementById('commentModal').classList.add('modal-top-layer'); // Ensure it's on top

      await fetchCommentsAndRender(storyId);
    }

    function closeCommentModal() {
      document.getElementById('commentModal').classList.remove('active');
      document.body.classList.remove('modal-open');
      document.getElementById('commentModal').classList.remove('modal-top-layer');
      document.getElementById('commentInput').value = ''; // Clear comment input
      currentCommentStoryId = null;
    }

    

    async function fetchCommentsAndRender(storyId) {
      try {
        const res = await fetch(`${API_BASE}/stories/${storyId}/comments`, {
          headers: { 'Authorization': token() }
        });
        if (!res.ok) throw new Error('Failed to fetch comments');
        const { comments } = await res.json();
        renderComments(comments);
      } catch (error) {
        console.error('Error fetching comments:', error);
        showToast('Failed to load comments.', 'error');
      }
    }

    function renderComments(comments) {
      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = ''; // Clear existing comments

      if (comments.length === 0) {
        commentsList.innerHTML = '<p style="text-align: center; color: var(--text-color);">No comments yet. Be the first to comment!</p>';
        return;
      }

      const userProfile = JSON.parse(localStorage.getItem('userProfile'));
      const currentUserId = userProfile ? userProfile.id : null;

      comments.forEach(comment => {
        const commentItem = document.createElement('div');
        commentItem.className = `comment-item ${comment.isAdmin ? 'admin-comment' : ''}`;
        commentItem.innerHTML = `
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <img class="comment-avatar" src="${comment.avatarUrl || generateDefaultAvatar(comment.author)}" alt="${comment.author}">
            <div class="comment-author">${comment.author}</div>
          </div>
          <div class="comment-text">${comment.text}</div>
          <div class="comment-actions" style="text-align: right; margin-top: 5px;">
            ${(currentUserId && comment.userId === currentUserId) || userProfile.isAdmin ? `
              <button class="text-button" style="margin-right: 8px;" onclick="editComment('${comment.id}', '${comment.text.replace(/'/g, '\'')}')"><i class="fas fa-pencil-alt"></i></button>
              <button class="text-button" onclick="deleteComment('${comment.id}')"><i class="fas fa-trash"></i></button>
            ` : ''}
          </div>
          <div class="comment-date">${new Date(comment.createdAt).toLocaleString()}</div>
        `;
        commentsList.appendChild(commentItem);
      });
    }

    

    let editingCommentId = null; // Global variable to store the ID of the comment being edited

    function editComment(commentId, commentText) {
      editingCommentId = commentId;
      document.getElementById('commentInput').value = commentText;
      document.getElementById('submitCommentBtn').textContent = 'Update Comment';
    }

    async function deleteComment(commentId) {
      // No confirmation, delete directly
      try {
        const res = await fetch(`${API_BASE}/comments/${commentId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': token()
          }
        });

        if (res.ok) {
          showToast('Comment deleted successfully!');
          await fetchCommentsAndRender(currentCommentStoryId); // Refresh comments
          renderAllStories(); // Re-render all stories to update counts
          renderMyStories(JSON.parse(localStorage.getItem('userProfile')).id); // Re-render user's stories
        } else {
          const errorData = await res.json();
          showToast(errorData.message || 'Failed to delete comment.', 'error');
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        showToast('An error occurred while deleting the comment.', 'error');
      }
    }

    

    

    function openEditNameModal() {
      document.getElementById('editNameModal').classList.add('active');
      // Optionally pre-fill current name
      const userProfile = JSON.parse(localStorage.getItem('userProfile'));
      if (userProfile && userProfile.name) {
        document.getElementById('newName').value = userProfile.name;
      }
      // Display name edit info (will be updated by loadProfile)
      document.getElementById('nameEditInfo').textContent = 'Loading name edit info...';
      loadProfile(); // Refresh profile data and update nameEditInfo
    }

    function closeEditNameModal() {
      document.getElementById('editNameModal').classList.remove('active');
      document.getElementById('newName').value = ''; // Clear input
    }

    function openNameConfirmModal(newName) {
      document.getElementById('confirmNewNameText').textContent = newName;
      document.getElementById('nameConfirmModal').classList.add('active');
    }

    function closeNameConfirmModal() {
      document.getElementById('nameConfirmModal').classList.remove('active');
    }

    
    let storyIdToDelete = null; // Global variable to store story ID

    let toastTimeout;

    function showToast(message, type = 'success') {
        const toast = document.getElementById('customToast');
        clearTimeout(toastTimeout);

        toast.textContent = message;
        toast.className = 'show';
        if (type === 'error') {
            toast.classList.add('error');
        } else {
            toast.classList.add('success');
        }

        const hideToast = () => {
            toast.classList.remove('show');
            window.removeEventListener('click', hideToast);
        };

        toastTimeout = setTimeout(hideToast, 5000);
        
        // Use a timeout to avoid capturing the same click that triggered the toast
        setTimeout(() => {
            window.addEventListener('click', hideToast, { once: true });
        }, 100);
    }

    let editingStoryId = null; // Global variable to store the ID of the story being edited

    // --- AUTOCOMPLETE ---
    const searchInput = document.getElementById("searchInput");
    const autocompleteContainer = document.getElementById("autocomplete-container");

    searchInput.addEventListener("input", function() {
        const val = this.value;
        const searchResultsContainer = document.getElementById("searchResultsContainer");
        if (!val) {
            closeAllLists();
            searchResultsContainer.style.marginTop = "0px";
            return false;
        }
        let arr = allPdfs.map(p => p.title);
        closeAllLists();
        let a = document.createElement("DIV");
        a.setAttribute("id", this.id + "autocomplete-list");
        a.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(a);
        
        const matchingTitles = arr.filter(title => title.substr(0, val.length).toUpperCase() == val.toUpperCase());
        const limitedTitles = matchingTitles.slice(0, 5);

        searchResultsContainer.style.marginTop = (limitedTitles.length * 40) + "px";

        for (let i = 0; i < limitedTitles.length; i++) {
            let b = document.createElement("DIV");
            b.innerHTML = "<strong>" + limitedTitles[i].substr(0, val.length) + "</strong>";
            b.innerHTML += limitedTitles[i].substr(val.length);
            b.innerHTML += "<input type='hidden' value='" + limitedTitles[i] + "'>";
            b.addEventListener("click", function() {
                searchInput.value = this.getElementsByTagName("input")[0].value;
                closeAllLists();
                searchResultsContainer.style.marginTop = "0px";
            });
            a.appendChild(b);
        }
    });

    function closeAllLists(elmnt) {
        var x = document.getElementsByClassName("autocomplete-items");
        const searchResultsContainer = document.getElementById("searchResultsContainer");
        for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != searchInput) {
                x[i].parentNode.removeChild(x[i]);
            }
        }
        searchResultsContainer.style.marginTop = "0px";
    }

    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });

    document.querySelectorAll('.toggle-password').forEach(item => {
        item.addEventListener('click', function (e) {
            const passwordInput = this.previousElementSibling;
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                this.classList.remove('fa-eye');
                this.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = "password";
                this.classList.remove('fa-eye-slash');
                this.classList.add('fa-eye');
            }
        });
    });

    

    function updateReactionCounts(storyCard, reactions) {
    const reactionCountsElement = storyCard.querySelector('.reaction-counts');
    if (!reactionCountsElement) return;

    // Clear existing counts
    reactionCountsElement.innerHTML = '';

    // Generate HTML for each reaction
    const reactionsHtml = Object.entries(reactions)
        .map(([emoji, count]) => `<span class="reaction-count">${emoji} ${count}</span>`)
        .join('');

    reactionCountsElement.innerHTML = reactionsHtml;
}

    document.getElementById("searchButton").addEventListener("click", () => {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const results = allPdfs.filter(pdf => pdf.title.toLowerCase().includes(searchTerm) || pdf.description.toLowerCase().includes(searchTerm));
        renderPdfCards("searchResultsContainer", results);
    });

    function editStory(storyId) {
      editingStoryId = storyId;
      const stories = getStories();
      const storyToEdit = stories.find(s => s.id === Number(storyId));

      if (storyToEdit) {
        document.getElementById('storyTitle').value = storyToEdit.title;
        document.getElementById('storyContent').value = storyToEdit.content;
        document.querySelector('#storyModal .auth-btn').textContent = 'Update Story'; // Change button text
        document.getElementById('deleteStoryFromModalBtn').style.display = 'block'; // Show delete button
        document.getElementById('deleteStoryFromModalBtn').textContent = 'Delete Story'; // Set button text
        document.getElementById('deleteStoryFromModalBtn').onclick = () => {
          closeStoryModal(); // Close the edit modal
          deleteStory(storyId, false); // Call the delete function, indicating it's a story
        };
        document.getElementById('storyModal').classList.add('active'); // Open modal
        document.getElementById('storyModal').classList.add('modal-top-layer'); // Add this line
      }
    }

    let isDeletingDraft = false; // Global flag to indicate if the item being deleted is a draft

    function deleteStory(idToDelete, isDraft = false) {
      let id = idToDelete;
      if (typeof idToDelete === 'string' && idToDelete.startsWith('story_')) {
        id = parseInt(idToDelete.split('_')[1], 10);
      }
      storyIdToDelete = id; // Store the ID
      isDeletingDraft = isDraft; // Set the flag
      document.getElementById('deleteConfirmModal').classList.add('active'); // Open the custom modal
      document.getElementById('deleteConfirmModal').classList.add('modal-top-layer'); // Add this line
    }

    // Event listeners for the custom delete confirmation modal
    document.getElementById('closeDeleteConfirmModal').addEventListener('click', () => {
      document.getElementById('deleteConfirmModal').classList.remove('active');
      storyIdToDelete = null; // Clear the stored ID
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
      document.getElementById('deleteConfirmModal').classList.remove('active');
      storyIdToDelete = null; // Clear the stored ID
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (storyIdToDelete) {
        const t = token();
        if (!t) {
          showToast("Please log in to delete stories.", 'error');
          return;
        }

        try {
          let endpoint = '';
        let successMessage = '';
        let errorMessage = '';

        if (isDeletingDraft) {
          endpoint = `${API_BASE}/stories/draft/${storyIdToDelete}`;
          successMessage = "Draft deleted successfully!";
          errorMessage = "Failed to delete draft.";
        } else {
          endpoint = `${API_BASE}/stories/${storyIdToDelete}`;
          successMessage = "Story deleted successfully!";
          errorMessage = "Failed to delete story.";
        }

        try {
          const res = await fetch(endpoint, {
            method: 'DELETE',
            headers: {
              'Authorization': t
            }
          });

          if (res.ok) {
            showToast(successMessage);
            // Re-render relevant sections
            const userProfile = JSON.parse(localStorage.getItem('userProfile'));
            if (userProfile) {
              renderMyStories(userProfile.id); // Re-render user's stories
              displayDrafts(userProfile.id); // Re-render user's drafts
            }
            renderAllStories(); // Re-render all stories (if on pencil page)
          } else {
            const errorData = await res.json();
            showToast(errorData.message || errorMessage, 'error');
          }
        } catch (error) {
          console.error("Error deleting item:", error);
          showToast("An error occurred while deleting the item.", 'error');
        }
        } catch (error) {
          console.error("Error deleting story:", error);
          showToast("An error occurred while deleting the story.", 'error');
        } finally {
          document.getElementById('deleteConfirmModal').classList.remove('active'); // Close modal
          document.getElementById('deleteConfirmModal').classList.remove('modal-top-layer'); // Add this line
          storyIdToDelete = null; // Clear the stored ID
          isDeletingDraft = false; // Reset the flag
        }
      }
    });

    async function handleReactionClick(storyId, emoji, clickedElement) {

      if (!token()) {
        showToast("Please log in to react.", 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/stories/${storyId}/react`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token()
          },
          body: JSON.stringify({ emoji })
        });

        if (res.ok) {
          const updatedStory = await res.json();
          // Update the UI with the new reaction counts
          const storyCard = document.querySelector(`.story-card[data-story-id='${storyId}']`);
          if (storyCard) {
            const reactionContainer = storyCard.querySelector('.reactions-container');
            const emojis = ['👍', '❤️', '😂', '🔥'];
            const reactionsHtml = emojis.map(emoji => {
              const count = updatedStory.reactions[emoji] || 0;
              const reactedClass = count > 0 ? 'reacted' : '';
              const onclickAttribute = isAccountPage ? '' : `onclick="event.stopPropagation(); handleReactionClick('${storyId}', '${emoji}', this)"`;
              return `<div class="reaction ${reactedClass}" data-emoji="${emoji}" ${onclickAttribute}>
                        <span class="emoji">${emoji}</span>
                        <span class="count">${count}</span>
                      </div>`;
            }).join('');
            reactionContainer.innerHTML = reactionsHtml;

            // Animation for the emoji
            console.log('Creating animated emoji for:', emoji); // Log 1
            const animatedEmoji = document.createElement('span');
            animatedEmoji.textContent = emoji;
            animatedEmoji.classList.add('animated-emoji'); // Add this line
            
            console.log('Animated emoji element created:', animatedEmoji); // Log 2

            const rect = clickedElement.getBoundingClientRect();
            console.log('Clicked element rect:', rect); // Log 3
            const offsetX = (Math.random() - 0.5) * 100; // Random offset between -50 and +50 pixels
            const offsetY = (Math.random() - 0.5) * 100; // Random offset between -50 and +50 pixels
            animatedEmoji.style.position = 'fixed'; // Add this line
            animatedEmoji.style.left = `${rect.left + rect.width / 2}px`;
            animatedEmoji.style.top = `${rect.top + rect.height / 2}px`;
            console.log('Animated emoji position:', animatedEmoji.style.left, animatedEmoji.style.top); // Log 4

            document.body.appendChild(animatedEmoji);
            console.log('Animated emoji appended to body.'); // Log 5

            animatedEmoji.addEventListener('animationend', () => {
                console.log('Animation ended, removing emoji.'); // Log 6
                animatedEmoji.remove();
            });
          }
        } else {
          const errorData = await res.json();
          showToast(errorData.message || "Failed to react.", 'error');
        }
      } catch (error) {
        console.error("Error reacting to story:", error);
        showToast("An error occurred while reacting.", 'error');
      }
    }

    function createStoryCardHtml(story, isCurrentUserStory, userProfile, isAccountPage) {
      // Ensure story.content is not null or undefined before calling substring
      const storyContentPreview = story.content ? story.content.substring(0, 100) + '...' : '';
      const authorAvatar = story.avatarUrl || generateDefaultAvatar(story.author);
      const createdAt = new Date(story.createdAt).toLocaleDateString();

      const reactions = story.reactions || {};
      const emojis = ['👍', '❤️', '😂', '🔥'];
      const reactionsHtml = emojis.map(emoji => {
        const count = reactions[emoji] || 0;
        const reactedClass = count > 0 ? 'reacted' : '';
        const onclickAttribute = isAccountPage ? '' : `onclick="event.stopPropagation(); handleReactionClick('${story.id}', '${emoji}', this)"`;
        return `<div class="reaction ${reactedClass}" data-emoji="${emoji}" ${onclickAttribute}>
                  <span class="emoji">${emoji}</span>
                  <span class="count">${count}</span>
                </div>`;
      }).join('');

      return `
                <div class="story-card ${story.isAdmin ? 'admin-story-border' : ''}" data-story-id="${story.id}" onclick="openStoryDisplayModal('${story.id}')">
          <div class="story-author-section">
            <img class="author-avatar" src="${authorAvatar}" alt="author">
            <div class="author-details">
              <div class="author-name">${story.author}</div>
              <div class="story-meta">${createdAt}</div>
              ${story.isAdmin ? '<div class="admin-tag">(Admin)</div>' : ''}
            </div>
          </div>
          <div class="story-content-section">
            <h4>${story.title}</h4>
            <p>${storyContentPreview}</p>
            <div class="reactions-container">
              ${reactionsHtml}
            </div>
          </div>
          <button class="comment-btn" onclick="event.stopPropagation(); openCommentModal('${story.id}')">
            <i class="fas fa-comment"></i>
            <span class="comment-count">${story.commentCount || 0}</span>
          </button>
          ${isCurrentUserStory || (userProfile && userProfile.isAdmin) ? `
            <button class="edit-story-btn" onclick="event.stopPropagation(); editStory('${story.id}')"><i class="fas fa-pencil-alt"></i></button>
            <button class="delete-story-btn" onclick="event.stopPropagation(); deleteStory('${story.id}')"><i class="fas fa-trash"></i></button>
          ` : ''}
        </div>

      `
    }

    document.getElementById("storyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const storyTitle = document.getElementById("storyTitle").value;
      const storyContent = document.getElementById("storyContent").value;
      const userProfile = JSON.parse(localStorage.getItem('userProfile'));
      console.log("Story form submission. userProfile:", userProfile); // Added log

      if (!userProfile || !userProfile.email) { // Changed from .id to .email
          showToast("Could not identify user. Please log in again.", 'error');
          return;
      }

      if (editingStoryId) {
        // Check if we are editing a draft or a story
        if (document.querySelector('#storyModal .auth-btn').textContent === 'Update Draft') {
            // Update existing draft via API
            try {
                const res = await fetch(`${API_BASE}/stories/draft/${editingStoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token()
                    },
                    body: JSON.stringify({ title: storyTitle, content: storyContent })
                });

                if (res.ok) {
                    showToast("Draft updated successfully!");
                    loadProfile(); // Re-render drafts
                    clearStoryDraft(); // Clear draft after successful update
                } else {
                    const errorData = await res.json();
                    showToast(errorData.message || "Failed to update draft.", 'error');
                }
            } catch (error) {
                console.error("Error updating draft:", error);
                showToast("An error occurred while updating the draft.", 'error');
            }
        } else {
            // Update existing story via API
            try {
                const res = await fetch(`${API_BASE}/stories/${editingStoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token()
                    },
                    body: JSON.stringify({ title: storyTitle, content: storyContent })
                });

                if (res.ok) {
                    showToast("Story updated successfully!");
                    renderAllStories(); // Re-render all stories from backend
                    renderMyStories(userProfile.id); // Re-render user's stories from backend
                    clearStoryDraft(); // Clear draft after successful update
                } else {
                    const errorData = await res.json();
                    showToast(errorData.message || "Failed to update story.", 'error');
                }
            } catch (error) {
                console.error("Error updating story:", error);
                showToast("An error occurred while updating the story.", 'error');
            }
        }
        editingStoryId = null; // Clear editing state
        document.querySelector('#storyModal .auth-btn').textContent = 'Publish Story'; // Reset button text
      } else {
        // Create new story
        try {
            const res = await fetch(`${API_BASE}/stories`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token()
                },
                body: JSON.stringify({ title: storyTitle, content: storyContent })
            });

            if (res.ok) {
                showToast("Story published successfully!");
                // The new story is on the server, so we need to re-render
                renderAllStories();
                renderMyStories(userProfile.id);
                clearStoryDraft(); // Clear draft after successful publication
            } else {
                const errorData = await res.json();
                showToast(errorData.message || "Failed to publish story.", 'error');
            }
        } catch (error) {
            console.error("Error publishing story:", error);
            showToast("An error occurred while publishing the story.", 'error');
        }
      }
      closeStoryModal();
      document.getElementById('storyForm').reset();
    });

    // Handle Pencil button click
    document.getElementById("pencilNavBtn").addEventListener("click", (event) => {
        document.querySelectorAll(".bottom-nav .nav-btn").forEach(b=>b.classList.remove("active"));
        event.currentTarget.classList.add("active");
        const page = event.currentTarget.dataset.page;
        document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
        document.getElementById(page).classList.add("active");
        renderAllStories();
    });

    // --- API & TOKEN HELPERS ---
    

    function openPdfModal(title, filePath, imageUrl, description) {
      currentPdfTitle = title;
      // Extract base name from filePath (e.g., 'pdfs/ATOMIC HABITS SUMMARY_light.pdf' -> 'pdfs/ATOMIC HABITS SUMMARY')
      // This assumes the _light.pdf or _dark.pdf suffix is always at the end before .pdf
      const lastDotIndex = filePath.lastIndexOf('.');
      const lastUnderscoreIndex = filePath.lastIndexOf('_');
      if (lastUnderscoreIndex > filePath.lastIndexOf('/') && lastUnderscoreIndex < lastDotIndex) {
        currentPdfBaseName = filePath.substring(0, lastUnderscoreIndex);
      } else {
        currentPdfBaseName = filePath.substring(0, lastDotIndex); // Fallback if no _light or _dark suffix
      }

      const pdfContentDiv = document.getElementById("pdfContent");
      pdfContentDiv.innerHTML = `
        <h3 id="pdfTitle">${title}</h3>
        <p>${description}</p>
        <div class="pdf-actions">
          <button class="action-button read-button">Read</button>
          <button class="action-button download-button">Download</button>
        </div>
        <button id="pdfFavBtn" class="fav-btn" onclick="toggleFavorite(currentPdfTitle, this)">🤍</button>
      `;
      document.getElementById("pdfModal").classList.add("active");
      updateFavButtons();

      pdfContentDiv.querySelector('.read-button').addEventListener('click', () => {
        currentPdfActionType = 'read';
        document.getElementById('themeSelectionPopup').classList.add('active');
        // No need to set dataset.pdfPath here, it will be constructed in the theme button listeners
        document.getElementById('lightModeBtn').dataset.pdfTitle = currentPdfTitle;
        document.getElementById('darkModeBtn').dataset.pdfTitle = currentPdfTitle;
      });

      pdfContentDiv.querySelector('.download-button').addEventListener('click', () => {
        currentPdfActionType = 'download';
        document.getElementById('themeSelectionPopup').classList.add('active');
        // No need to set dataset.pdfPath here, it will be constructed in the theme button listeners
        document.getElementById('lightModeBtn').dataset.pdfTitle = currentPdfTitle;
        document.getElementById('darkModeBtn').dataset.pdfTitle = currentPdfTitle;
      });
    }

    function closePdfModal() {
      document.getElementById("pdfModal").classList.remove("active");
      currentPdfTitle = null;
    }

    function addPdfToRecentlyViewed(pdfTitle) {
      let viewed = JSON.parse(sessionStorage.getItem('recentlyViewed')) || [];
      viewed = viewed.filter(item => item.pdf !== pdfTitle);
      viewed.unshift({ pdf: pdfTitle, date: new Date().toISOString() });
      if (viewed.length > 50) viewed = viewed.slice(0, 50);
      sessionStorage.setItem('recentlyViewed', JSON.stringify(viewed));
      renderViewed();
    }

    document.getElementById('lightModeBtn').addEventListener('click', (event) => {
      const pdfTitle = event.target.dataset.pdfTitle;
      const pdfPath = currentPdfBaseName + '_light.pdf'; // Construct light mode PDF path
      document.getElementById('themeSelectionPopup').classList.remove('active');
      if (currentPdfActionType === 'read') {
        window.open(`${pdfPath}#toolbar=0&navpanes=0&scrollbar=0&view=FitH&pagemode=none&background=FFFFFF`, '_blank');
      } else if (currentPdfActionType === 'download') {
        const link = document.createElement('a');
        link.href = pdfPath;
        link.download = pdfTitle + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      addPdfToRecentlyViewed(pdfTitle);
      closePdfModal();
    });

    document.getElementById('darkModeBtn').addEventListener('click', (event) => {
      const pdfTitle = event.target.dataset.pdfTitle;
      const pdfPath = currentPdfBaseName + '_dark.pdf'; // Construct dark mode PDF path
      document.getElementById('themeSelectionPopup').classList.remove('active');
      if (currentPdfActionType === 'read') {
        window.open(`${pdfPath}#toolbar=0&navpanes=0&scrollbar=0&view=FitH&pagemode=none&background=000000`, '_blank');
      } else if (currentPdfActionType === 'download') {
        const link = document.createElement('a');
        link.href = pdfPath;
        link.download = pdfTitle + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      addPdfToRecentlyViewed(pdfTitle);
      closePdfModal();
    });

    // --- DATA RENDERING & API CALLS ---
    function renderPdfCards(containerId, pdfs) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      if (pdfs.length === 0) {
        container.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">No items to display.</p>';
        return;
      }
      container.innerHTML = pdfs.map(pdf => `
        <div class="category" data-title="${pdf.title}" onclick="openPdfModal('${pdf.title}', '${pdf.filePath}', '${pdf.imageUrl}', '${pdf.description}')">
          <h3>${pdf.title}</h3>
          ${pdf.category ? `<p class="pdf-card-category">in ${pdf.category}</p>` : ''}
          <button class="fav-btn" onclick="toggleFavorite('${pdf.title}', this); event.stopPropagation();">🤍</button>
        </div>
      `).join('');
      updateFavButtons();
    }

    function updateFavButtons(favorites) {
      if (!favorites) {
        const profile = JSON.parse(localStorage.getItem('userProfile'));
        favorites = profile ? profile.favorites : [];
      }
      document.querySelectorAll(".fav-btn").forEach(btn => {
        const card = btn.closest(".category, .library-card");
        const title = card ? card.dataset.title : null;
        if (title && favorites.includes(title)) {
          btn.textContent = '❤️';
          btn.classList.add('active');
        } else {
          btn.textContent = '🤍';
          btn.classList.remove('active');
        }
      });
      const pdfFavBtn = document.getElementById("pdfFavBtn");
      if (currentPdfTitle && pdfFavBtn) {
        if (favorites.includes(currentPdfTitle)) {
          pdfFavBtn.textContent = '❤️';
        } else {
          pdfFavBtn.textContent = '🤍';
        }
      }
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("userProfile");
      showToast("Logged out successfully!");
      loadProfile();
      document.querySelector(".nav-btn[data-page='home']").click();
      document.querySelector(".create-story p").textContent = "Log in to create a story";

      // Clear login form fields
      document.getElementById("loginEmail").value = "";
      document.getElementById("loginPassword").value = "";
    }

    async function loadProfile() {
      console.log("loadProfile called"); // Debug log
      const t = token();
      const openAuthBtn = document.getElementById("openAuthBtn");
      const authModal = document.getElementById("authModal");
      const createStoryP = document.querySelector(".create-story p");
      let userProfile = JSON.parse(localStorage.getItem('userProfile'));
      console.log("userProfile object after parsing from localStorage in loadProfile:", userProfile); // Debug log
      console.log("Initial userProfile from localStorage in loadProfile:", userProfile); // Debug log

      if (!t || !userProfile) {
        console.log("No token or userProfile found in loadProfile. Setting to guest mode."); // Debug log
        document.querySelector("#account .profile-name").textContent = 'Guest';
        document.querySelector("#account .profile-bio").textContent = 'Please login to view profile';
        document.querySelector('.profile-avatar').src = generateDefaultAvatar('Guest');
        localStorage.removeItem('userProfile');
        openAuthBtn.textContent = "Login / Register";
        openAuthBtn.onclick = () => authModal.classList.add("active");
        authModal.classList.remove("active");
        renderMyStories(null); // Clear stories when logged out
        if(createStoryP) createStoryP.textContent = "Log in to create a story";
        updateFavButtons([]); // Pass empty array for guest
        return;
      }

      try {
        console.log("Fetching profile from API in loadProfile..."); // Debug log
        const res = await fetch(`${API_BASE}/profile`, {
          headers: { 'Authorization': t }
        });

        if (res.ok) {
          const profileFromServer = await res.json();
          console.log("Profile fetched from server in loadProfile:", profileFromServer); // Debug log
          localStorage.setItem('userProfile', JSON.stringify(profileFromServer)); // Update localStorage
          userProfile = profileFromServer; // Update local variable

          // Fetch and display name edit info
          document.getElementById('nameEditInfo').style.display = 'block';
          try {
            const nameInfoRes = await fetch(`${API_BASE}/user/name-changes-info`, {
              headers: { 'Authorization': t }
            });
            if (nameInfoRes.ok) {
              const nameInfo = await nameInfoRes.json();
              let infoText;
              const now = new Date(); // Moved 'now' here
              if (nameInfo.remainingChanges === -1) {
                infoText = `Name changes left: Unlimited.`;
              } else {
                infoText = `Name changes left: ${nameInfo.remainingChanges}/3.`;
                if (nameInfo.remainingChanges <= 0 && nameInfo.resetDate) {
                  const resetDate = new Date(nameInfo.resetDate);
                  const remainingMs = resetDate.getTime() - now.getTime();
                  const remainingDays = Math.ceil(remainingMs / (1000 * 60 * 60 * 24));
                  if (remainingDays > 0) {
                    infoText += ` Next change available in ${remainingDays} days.`;
                  } else {
                    infoText += ` You can change your name again now.`;
                  }
                } else if (nameInfo.remainingChanges > 0 && nameInfo.lastChangeTimestamp) {
                  const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                  const timeSinceLastChange = now.getTime() - nameInfo.lastChangeTimestamp;
                  if (timeSinceLastChange < thirtyDays) {
                    const remainingDays = Math.ceil((thirtyDays - timeSinceLastChange) / (1000 * 60 * 60 * 24));
                    infoText += ` Resets in ${remainingDays} days.`;
                  }
                }
              }
              document.getElementById('nameEditInfo').textContent = infoText;
            } else {
              console.error('Failed to fetch name change info:', await nameInfoRes.json());
              document.getElementById('nameEditInfo').textContent = 'Could not load name change info.';
            }
          } catch (error) {
            console.error('Error fetching name change info:', error);
            document.getElementById('nameEditInfo').textContent = 'Error loading name change info.';
          }
        } else {
          console.log("Failed to fetch profile from server in loadProfile. Logging out."); // Debug log
          // If profile fetch fails, logout the user
          logout();
          return;
        }
      } catch (error) {
        console.error("Error loading profile in loadProfile:", error); // Debug log
        logout(); // Logout on error
        return;
      }

      document.querySelector("#account .profile-name").textContent = userProfile.name;
      document.querySelector("#account .profile-bio").textContent = userProfile.email;
      document.querySelector('.profile-avatar').src = userProfile.avatarUrl || generateDefaultAvatar(userProfile.name);
      if(createStoryP) createStoryP.textContent = "Create a new story";
      renderFavorites(userProfile.favorites || []);
      renderViewed();
      if (userProfile && userProfile.id) { // Ensure userProfile and its id exist
        renderMyStories(userProfile.id);
        displayDrafts(userProfile.id);
      } else {
        console.error("userProfile or userProfile.id is missing, cannot render stories/drafts.");
        renderMyStories(null); // Render as guest
        displayDrafts(null); // Render as guest
      }
      updateFavButtons(userProfile.favorites || []);

      openAuthBtn.textContent = "Logout";
      openAuthBtn.onclick = logout;
      authModal.classList.remove("active");
    }

    async function toggleFavorite(pdfTitle, buttonElement) {
      const t = token();
      if (!t) {
        showToast("Please log in to add favorites.", 'error');
        return;
      }

      const isFavorited = buttonElement.textContent.includes('❤️');
      const method = isFavorited ? 'DELETE' : 'POST';
      const url = isFavorited ? `${API_BASE}/favorites/${encodeURIComponent(pdfTitle)}` : `${API_BASE}/favorites`;
      const body = isFavorited ? null : JSON.stringify({ pdf: pdfTitle });

      try {
        const res = await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json", "Authorization": t },
          body: body
        });

        if (res.ok) {
          buttonElement.textContent = isFavorited ? '🤍' : '❤️';
          buttonElement.classList.toggle('active', !isFavorited);
          // No toast here, the visual feedback is enough
          loadProfile();
        } else {
          const errorData = await res.json();
          showToast(errorData.message || "Failed to update favorites.", 'error');
        }
      } catch (error) {
        console.error("Error toggling favorite:", error);
        showToast("An error occurred while updating favorites.", 'error');
      }
    }

    function renderFavorites(favorites) {
      const container = document.getElementById("favoritesContainer");
      if (!container) return;
      container.innerHTML = '';

      if (favorites.length === 0) {
        container.innerHTML = '<p>No favorites added yet.</p>';
        return;
      }

      favorites.forEach(favTitle => {
        const pdf = allPdfs.find(p => p.title === favTitle);
        if (pdf) {
          const card = document.createElement('div');
          card.className = 'library-card';
          card.dataset.title = pdf.title;
          card.setAttribute('onclick', `openPdfModal('${pdf.title}', '${pdf.filePath}', '${pdf.imageUrl}', '${pdf.description}')`);
          card.innerHTML = `
            <h4>${pdf.title}</h4>
            <p>Added: Just now</p>
            <button class="fav-btn active" onclick="toggleFavorite('${pdf.title}', this); event.stopPropagation();">❤️</button>
          `;
          container.appendChild(card);
        }
      });
      updateFavButtons(favorites);
    }

    function renderViewed() {
      const container = document.getElementById("viewedContainer");
      if (!container) return;
      container.innerHTML = '';
      let viewedPdfs = JSON.parse(sessionStorage.getItem('recentlyViewed')) || [];

      if (viewedPdfs.length === 0) {
        container.innerHTML = '<p>No recently viewed PDFs.</p>';
        return;
      }

      viewedPdfs.forEach(viewedPdf => {
        const pdf = allPdfs.find(p => p.title === viewedPdf.pdf);
        if (pdf) {
          const card = document.createElement('div');
          card.className = 'library-card';
          card.dataset.title = pdf.title;
          card.setAttribute('onclick', `openPdfModal('${pdf.title}', '${pdf.filePath}', '${pdf.imageUrl}', '${pdf.description}')`);
          card.innerHTML = `
            <h4>${pdf.title}</h4>
            <p>Last viewed: ${new Date(viewedPdf.date).toLocaleDateString()}</p>
            <button class="fav-btn" onclick="toggleFavorite('${pdf.title}', this); event.stopPropagation();">🤍</button>
          `;
          container.appendChild(card);
        }
      });
      updateFavButtons();
    }

    function renderMyStories(userId) {
  console.log("renderMyStories called with userId:", userId); // Debug log
  const myStoriesContainer = document.getElementById('myStoriesContainer');
  if (!myStoriesContainer) return;

  const stories = getStories();
  console.log("Stories from localStorage in renderMyStories:", stories); // Debug log
  let userStories = userId ? stories.filter(story => {
    console.log(`Filtering in renderMyStories: story.userId (${story.userId}), current userId (${userId})`); // Debug log
    return story.userId === userId;
  }) : [];
  // Sort user stories: admin stories first, then by creation date (newest first)
  userStories.sort((a, b) => {
    if (a.isAdmin && !b.isAdmin) return -1; // a is admin, b is not, a comes first
    if (!a.isAdmin && b.isAdmin) return 1;  // b is admin, a is not, b comes first
    return new Date(b.createdAt) - new Date(a.createdAt); // Sort by date for non-admins or both admins
  });
  console.log("Filtered userStories in renderMyStories:", userStories); // Debug log

  myStoriesContainer.innerHTML = ''; // Clear previous content

  if (userStories.length > 0) {
    // Display only the first 5 stories
    const limitedStories = userStories.slice(0, 5);
    const isAccountPage = document.querySelector('#account.active') !== null;
    myStoriesContainer.innerHTML = limitedStories.map(story => {
      const isCurrentUserStory = (userId && story.userId === userId);
      const userProfile = JSON.parse(localStorage.getItem('userProfile'));
      return createStoryCardHtml(story, isCurrentUserStory, userProfile, isAccountPage);
    }).join('');

    // Add "View All" button if there are more than 5 stories
    if (userStories.length > 5) {
      const viewAllContainer = document.createElement('div');
      viewAllContainer.className = 'view-all-container'; // New class for styling
      const viewAllBtn = document.createElement('button');
      viewAllBtn.className = 'auth-btn'; // Reusing existing button style
      viewAllBtn.textContent = 'View All'; // Changed text
      viewAllBtn.onclick = () => openViewAllStoriesModal(userStories); // Pass all stories
      viewAllContainer.appendChild(viewAllBtn);
      myStoriesContainer.appendChild(viewAllContainer);
    }
  } else {
    myStoriesContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">You have not posted any stories yet.</p>';
  }
}

    function openViewAllStoriesModal(stories) {
      const allMyStoriesContainer = document.getElementById('allMyStoriesContainer');
      if (!allMyStoriesContainer) return;

      const userProfile = JSON.parse(localStorage.getItem('userProfile'));
      const userId = userProfile ? userProfile.id : null;

      allMyStoriesContainer.innerHTML = stories.map(story => {
        const isCurrentUserStory = (userId && story.userId === userId);
        return createStoryCardHtml(story, isCurrentUserStory, userProfile);
      }).join('');

      document.getElementById('viewAllStoriesModal').classList.add('active');
      document.body.classList.add('modal-open'); // Add this line
    }

    function closeViewAllStoriesModal() {
      document.getElementById('viewAllStoriesModal').classList.remove('active');
      document.body.classList.remove('modal-open'); // Add this line
    }

async function displayDrafts(userId) {
  const myDraftsContainer = document.getElementById('myDraftsContainer');
  if (!myDraftsContainer) return;

  if (!userId) {
    myDraftsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">Log in to see your drafts.</p>';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/users/${userId}/drafts`, {
      headers: { 'Authorization': token() }
    });
    if (!res.ok) {
      throw new Error('Failed to fetch drafts');
    }
    const { drafts } = await res.json();

    myDraftsContainer.innerHTML = ''; // Clear previous content

    if (drafts.length > 0) {
      // Display only the first 5 drafts
      const limitedDrafts = drafts.slice(0, 5);
      myDraftsContainer.innerHTML = limitedDrafts.map(draft => `
        <div class="story-card" data-draft-id="${draft.id}" onclick="openStoryDisplayModal('${draft.id}')">
          <div class="story-content-section">
            <h4>${draft.title}</h4>
            <p>${draft.content.substring(0, 100)}...</p>
          </div>
          <div class="story-actions">
            <button class="edit-story-btn" onclick="event.stopPropagation(); editDraft('${draft.id}')"><i class="fas fa-pencil-alt"></i></button>
            <button class="delete-story-btn" onclick="event.stopPropagation(); deleteStory('${draft.id}', true)"><i class="fas fa-trash"></i></button>
            <button class="publish-draft-btn" onclick="event.stopPropagation(); publishDraft('${draft.id}')">Publish</button>
          </div>
        </div>
      `).join('');

      // Add "View All" button if there are more than 5 drafts
      if (drafts.length > 5) {
        const viewAllContainer = document.createElement('div');
        viewAllContainer.className = 'view-all-container'; // New class for styling
        const viewAllBtn = document.createElement('button');
        viewAllBtn.className = 'auth-btn'; // Reusing existing button style
        viewAllBtn.textContent = 'View All'; // Changed text
        viewAllBtn.onclick = () => openViewAllDraftsModal(drafts); // Pass all drafts
        viewAllContainer.appendChild(viewAllBtn);
        myDraftsContainer.appendChild(viewAllContainer);
      }
    } else {
      myDraftsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">You have no saved drafts.</p>';
    }
  } catch (error) {
    console.error('Error loading drafts:', error);
    myDraftsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">Error loading drafts.</p>';
  }
}

    function openViewAllDraftsModal(drafts) {
      const allMyDraftsContainer = document.getElementById('allMyDraftsContainer');
      if (!allMyDraftsContainer) return;

      allMyDraftsContainer.innerHTML = drafts.map(draft => `
        <div class="story-card" data-draft-id="${draft.id}" onclick="openStoryDisplayModal('${draft.id}')">
          <div class="story-content-section">
            <h4>${draft.title}</h4>
            <p>${draft.content.substring(0, 100)}...</p>
          </div>
          <div class="story-actions">
            <button class="edit-story-btn" onclick="event.stopPropagation(); editDraft('${draft.id}')"><i class="fas fa-pencil-alt"></i></button>
            <button class="delete-story-btn" onclick="event.stopPropagation(); deleteStory('${draft.id}', true)"><i class="fas fa-trash"></i></button>
            <button class="publish-draft-btn" onclick="event.stopPropagation(); publishDraft('${draft.id}')">Publish</button>
          </div>
        </div>
      `).join('');

      document.getElementById('viewAllDraftsModal').classList.add('active');
      document.body.classList.add('modal-open'); // Add this line
    }

    function closeViewAllDraftsModal() {
      document.getElementById('viewAllDraftsModal').classList.remove('active');
      document.body.classList.remove('modal-open'); // Add this line
    }

async function editDraft(draftId) {
  try {
    const res = await fetch(`${API_BASE}/users/${JSON.parse(localStorage.getItem('userProfile')).id}/drafts`, {
        headers: { 'Authorization': token() }
    });
    if (!res.ok) throw new Error('Failed to fetch drafts');
    const { drafts } = await res.json();
    const draftToEdit = drafts.find(d => d.id === Number(draftId));

    if (draftToEdit) {
        document.getElementById('storyTitle').value = draftToEdit.title;
        document.getElementById('storyContent').value = draftToEdit.content;
        editingStoryId = draftId; // Using existing editingStoryId to store draftId
        document.querySelector('#storyModal .auth-btn').textContent = 'Update Draft';
        document.getElementById('deleteStoryFromModalBtn').style.display = 'block'; // Show delete button
        document.getElementById('deleteStoryFromModalBtn').textContent = 'Delete Draft'; // Set button text
        document.getElementById('deleteStoryFromModalBtn').onclick = () => {
          closeStoryModal(); // Close the edit modal
          deleteStory(draftId, true); // Call the delete function, indicating it's a draft
        };
        document.getElementById('storyModal').classList.add('active');
        document.getElementById('storyModal').classList.add('modal-top-layer'); // Add this line
    }
  } catch (error) {
      console.error('Error fetching draft for editing:', error);
      alert('Could not load draft for editing.');
  }
}

async function publishDraft(draftId) {
  // No confirmation alert, proceed directly
  try {
    const res = await fetch(`${API_BASE}/users/${JSON.parse(localStorage.getItem('userProfile')).id}/drafts`, {
        headers: { 'Authorization': token() }
    });
    if (!res.ok) throw new Error('Failed to fetch drafts');
    const { drafts } = await res.json();
    const draftToPublish = drafts.find(d => d.id === Number(draftId));

    if (draftToPublish) {
      // Now, publish it as a new story
      const publishRes = await fetch(`${API_BASE}/stories`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token()
        },
        body: JSON.stringify({ title: draftToPublish.title, content: draftToPublish.content })
      });

      if (publishRes.ok) {
        showToast('Draft published successfully!');
        // Optionally, delete the draft after publishing
        await fetch(`${API_BASE}/stories/draft/${draftId}`, { method: 'DELETE', headers: { 'Authorization': token() } });
        loadProfile();
      } else {
        const errorData = await publishRes.json();
        showToast(errorData.message || 'Failed to publish draft.', 'error');
      }
    }
  } catch (error) {
    console.error('Error publishing draft:', error);
    showToast('An error occurred while publishing the draft.', 'error');
  }
}

// --- AVATAR LOGIC ---
function getAvatarColor(char) {
    const colors = [
        '#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', 
        '#a0c4ff', '#bdb2ff', '#ffc6ff', '#fffffc'
    ];
    const charCode = char.toUpperCase().charCodeAt(0) || 0;
    return colors[charCode % colors.length];
}

function generateDefaultAvatar(name) {
    const firstLetter = (name || 'G')[0].toUpperCase();
    const bgColor = getAvatarColor(firstLetter);
    const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
            <rect width="100" height="100" fill="${bgColor}"></rect>
            <text x="50" y="50" font-family="'Segoe UI', sans-serif" font-size="50" dy=".35em" text-anchor="middle" fill="#333">${firstLetter}</text>
        </svg>
    `;
    return `data:image/svg+xml;base64,${btoa(svg)}`;
}

function populateAvatarGrid() {
    const grid = document.getElementById('avatarGrid');
    if (!grid) return;
    let optionsHtml = '';
    // Use DiceBear for cartoon-style avatars
    for (let i = 0; i < 200; i++) {
        const avatarUrl = `https://api.dicebear.com/7.x/adventurer/svg?seed=${i}`;
        optionsHtml += `<img src="${avatarUrl}" class="avatar-option" data-url="${avatarUrl}" alt="Avatar option ${i+1}">`;
    }
    grid.innerHTML = optionsHtml;
}

async function updateUserAvatar(avatarUrl) {
    try {
        const res = await fetch(`${API_BASE}/profile/avatar`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token()
            },
            body: JSON.stringify({ avatarUrl })
        });

        if (!res.ok) throw new Error('Failed to update avatar');

        const data = await res.json();
        showToast('Avatar updated successfully!');
        // Update avatar on the page immediately
        document.querySelector('.profile-avatar').src = data.avatarUrl;
        // Update localStorage
        const userProfile = JSON.parse(localStorage.getItem('userProfile'));
        if (userProfile) {
            userProfile.avatarUrl = data.avatarUrl;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }
        document.getElementById('avatarModal').classList.remove('active');
    } catch (error) {
        console.error('Error updating avatar:', error);
        alert('Failed to update avatar.');
    }
}

document.getElementById('editAvatarBtn').addEventListener('click', () => {
    if (!token()) {
        document.getElementById('authModal').classList.add('active');
        return;
    }
    populateAvatarGrid();
    document.getElementById('avatarModal').classList.add('active');
});

document.getElementById('closeAvatarModal').addEventListener('click', () => {
    document.getElementById('avatarModal').classList.remove('active');
});

document.getElementById('avatarGrid').addEventListener('click', (e) => {
    if (e.target.classList.contains('avatar-option')) {
        const selectedUrl = e.target.dataset.url;
        updateUserAvatar(selectedUrl);
    }
});

document.getElementById('avatarUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64String = event.target.result;
            updateUserAvatar(base64String);
        };
        reader.readAsDataURL(file);
    }
});

async function renderHome() {
  const container = document.getElementById('dynamicHomeCategories');
  if (!container) return;

  try {
    const res = await fetch(`${API_BASE}/home_pdfs`);
    if (!res.ok) throw new Error('Failed to fetch home page data');
    const { categories } = await res.json();

    if (!categories || categories.length === 0) {
      // Don't show an error, just leave it blank if no folders exist
      container.innerHTML = '';
      return;
    }

    let html = '';
    categories.forEach(category => {
      if (category.pdfs.length > 0) {
        html += `<h2 class="section-title">${category.name}</h2>`;
        html += '<div class="categories-container">'; // Use categories-container for horizontal scroll
        category.pdfs.forEach(pdf => {
          html += `
            <div class="category" data-title="${pdf.title}" onclick="openPdfModal('${pdf.title}', '${pdf.filePath}', '', '${pdf.description}')">
              <h3>${pdf.title}</h3>
              <button class="fav-btn" onclick="toggleFavorite('${pdf.title}', this); event.stopPropagation();">🤍</button>
            </div>
          `;
        });
        html += '</div>';
      }
    });

    container.innerHTML = html;
    updateFavButtons();
  } catch (error) {
    console.error('Error rendering home page:', error);
    container.innerHTML = '<p>Error loading home page content.</p>';
  }
}

async function renderLibrary() {
  const container = document.getElementById('dynamicLibraryCategories');
  if (!container) return;

  try {
    const res = await fetch(`${API_BASE}/pdfs`);
    if (!res.ok) throw new Error('Failed to fetch library data');
    const { categories } = await res.json();

    if (!categories || categories.length === 0) {
      container.innerHTML = '<p>No categories found.</p>';
      return;
    }
    allPdfs = categories.flatMap(c => c.pdfs);
    console.log("allPdfs array populated with", allPdfs.length, "PDFs.");

    allPdfs = categories.flatMap(c => c.pdfs);
    console.log("allPdfs array populated with", allPdfs.length, "PDFs.");

    let html = '';
    categories.forEach(category => {
      if (category.pdfs.length > 0) {
        html += `<h2 class="section-title">${category.name}</h2>`;
        html += '<div class="library-cards">';
        category.pdfs.forEach(pdf => {
          html += `
            <div class="library-card" data-title="${pdf.title}" onclick="openPdfModal('${pdf.title}', '${pdf.filePath}', '', '${pdf.description}')">
              <h4>${pdf.title}</h4>
              <p>Click to view</p>
              <button class="fav-btn" onclick="toggleFavorite('${pdf.title}', this); event.stopPropagation();">🤍</button>
            </div>
          `;
        });
        html += '</div>';
      }
    });

    container.innerHTML = html;
    updateFavButtons(); // Update favorite buttons after rendering
  } catch (error) {
    console.error('Error rendering library:', error);
    container.innerHTML = '<p>Error loading library. Please try again later.</p>';
  }
}

    // --- DOMContentLoaded ---
    document.addEventListener("DOMContentLoaded", async () => {
      renderHome();
      renderLibrary();
      sessionStorage.removeItem('recentlyViewed'); // Clear recently viewed on refresh
      
      // We still need to populate the global allPdfs array for other functions like search and favorites
      try {
        const res = await fetch(`${API_BASE}/pdfs`);
        if (!res.ok) throw new Error('Failed to fetch PDF list');
        const data = await res.json();
        if (data.categories) {
          allPdfs = data.categories.reduce((acc, category) => acc.concat(category.pdfs), []);
        }
      } catch(e) {
        console.error("Error fetching PDFs for global list:", e);
      }

      renderAllStories();
      loadProfile();
      renderViewed();

      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchButton");
      const searchResultsContainer = document.getElementById("searchResultsContainer");
      let searchTimeout;

      const performSearch = async () => {
        const query = searchInput.value.trim();
        if (query.length > 0) {
          try {
            const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error('Failed to fetch search results');
            const data = await res.json();
            if (data.results && data.results.length > 0) {
              renderPdfCards("searchResultsContainer", data.results);
            } else {
              searchResultsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">No PDFs found matching your search.</p>';
            }
          } catch (e) {
            console.error("Error fetching search results:", e);
            searchResultsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">Error searching for PDFs. Please try again.</p>';
          }
        } else {
          searchResultsContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px; color: var(--text-color);">Start typing to search for PDFs.</p>';
        }
      };

      searchInput.addEventListener("input", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });
      searchButton.addEventListener("click", performSearch);

      // Event listeners for comment modal buttons
      document.getElementById('closeCommentModal').addEventListener('click', closeCommentModal);
      document.getElementById('submitCommentBtn').addEventListener('click', async () => {
        const commentInput = document.getElementById('commentInput');
        const commentText = commentInput.value.trim();

        if (!commentText) {
          showToast('Comment cannot be empty.', 'error');
          return;
        }

        if (!currentCommentStoryId) {
          showToast('No story selected for commenting.', 'error');
          return;
        }

        let url = '';
        let method = '';
        let successMessage = '';
        let errorMessage = '';

        if (editingCommentId) {
          url = `${API_BASE}/comments/${editingCommentId}`;
          method = 'PUT';
          successMessage = 'Comment updated successfully!';
          errorMessage = 'Failed to update comment.';
        } else {
          url = `${API_BASE}/stories/${currentCommentStoryId}/comments`;
          method = 'POST';
          successMessage = 'Comment added successfully!';
          errorMessage = 'Failed to add comment.';
        }

        try {
          const res = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': token()
            },
            body: JSON.stringify({ text: commentText })
          });

          if (res.ok) {
            showToast(successMessage);
            commentInput.value = ''; // Clear input
            document.getElementById('submitCommentBtn').textContent = 'Submit Comment'; // Reset button text
            editingCommentId = null; // Clear editing state
            await fetchCommentsAndRender(currentCommentStoryId); // Refresh comments
            renderAllStories(); // Re-render all stories to update counts
            renderMyStories(JSON.parse(localStorage.getItem('userProfile')).id); // Re-render user's stories
          } else {
            const errorData = await res.json();
            showToast(errorData.message || errorMessage, 'error');
          }
        } catch (error) {
          console.error('Error submitting/updating comment:', error);
          showToast('An error occurred while submitting/updating your comment.', 'error');
        }
      });
    });

    // About Us Toggle Functionality
    const aboutUsToggle = document.getElementById('aboutUsToggle');
    const aboutUsContent = document.querySelector('.about-us-content');

    aboutUsToggle.addEventListener('click', () => {
      aboutUsToggle.classList.toggle('active');
      aboutUsContent.classList.toggle('active');
      // Toggle a class on the parent section to control its padding
      aboutUsToggle.closest('.about-us-section').classList.toggle('is-collapsed');
    });

    document.getElementById('closeThemeSelectionPopup').addEventListener('click', () => {
      document.getElementById('themeSelectionPopup').classList.remove('active');
    });
  // --- FORGOT PASSWORD ---
    

    

    document.getElementById("resetPasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      let identifier; // Will be phoneNumber or email

      if (currentOtpMethod === 'phone') {
        const phonePrefix = document.getElementById("forgotPhonePrefix").value;
        identifier = phonePrefix + document.getElementById("forgotPhone").value;
      } else { // currentOtpMethod === 'email'
        identifier = document.getElementById("forgotEmail").value;
      }

      const otp = document.getElementById("otpCode").value;
      const newPassword = document.getElementById("newPassword").value;
      const confirmNewPassword = document.getElementById("confirmNewPassword").value;

      if (newPassword !== confirmNewPassword) {
        showToast("New passwords do not match.", 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/reset-password`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ [currentOtpMethod]: identifier, otp, newPassword }),
        });

        const data = await res.json();

        if (res.ok) {
          showToast(data.message);
          closeForgotPasswordModal();
          // Optionally, switch to login tab or auto-login
        } else {
          showToast(data.message || "Failed to reset password.", 'error');
        }
      } catch (error) {
        console.error("Reset password error:", error);
        showToast("An error occurred while resetting password.", 'error');
      }
    });
  // --- RESEND OTP ---
    let resendOtpTimer;
    let resendOtpCountdown = 60;
    const resendOtpBtn = document.getElementById("resendOtpBtn");

    function startResendOtpTimer() {
      resendOtpCountdown = 60;
      resendOtpBtn.disabled = true;
      resendOtpBtn.textContent = `Resend OTP (${resendOtpCountdown}s)`;

      resendOtpTimer = setInterval(() => {
        resendOtpCountdown--;
        resendOtpBtn.textContent = `Resend OTP (${resendOtpCountdown}s)`;
        if (resendOtpCountdown <= 0) {
          clearInterval(resendOtpTimer);
          resendOtpBtn.disabled = false;
          resendOtpBtn.textContent = "Resend OTP";
        }
      }, 1000);
    }

    resendOtpBtn.addEventListener("click", async () => {
      const phoneNumber = document.getElementById("forgotPhone").value;
      if (!phoneNumber) {
        showToast("Please enter your phone number first.", 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/send-otp`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ phoneNumber }),
        });

        const data = await res.json();

        if (res.ok) {
          showToast(data.message);
          startResendOtpTimer(); // Start timer on successful resend
        } else {
          showToast(data.message || "Failed to resend OTP.", 'error');
        }
      } catch (error) {
        console.error("Resend OTP error:", error);
        showToast("An error occurred while resending OTP.", 'error');
      }
    });
  // --- EDIT NAME ---
    // Global variable to store the new name temporarily
    let pendingNewName = '';

    document.getElementById("editNameForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      let newName = document.getElementById("newName").value; // Use let to allow modification
      const token = localStorage.getItem('token');

      // Name validation
      newName = newName.trim(); // Trim leading/trailing spaces
      if (newName.length < 2 || newName.length > 20) {
        showToast("Name must be between 2 and 20 characters long.", 'error');
        return;
      }
      if (!/^[a-zA-Z0-9\s\-\'.]+\$/.test(newName)) { // Allowed characters
        showToast("Name can only contain letters, numbers, spaces, hyphens, apostrophes, and periods.", 'error');
        return;
      }
      if (/\s\s+/.test(newName)) { // No consecutive spaces
        showToast("Name cannot contain consecutive spaces.", 'error');
        return;
      }

      if (!token) {
        showToast("You must be logged in to change your name.", 'error');
        return;
      }

      // Store the new name and open confirmation modal
      pendingNewName = newName;
      openNameConfirmModal(newName);
    });

    // Function to handle the actual name change API call
    async function confirmNameChange() {
      const newName = pendingNewName; // Use the stored name
      const token = localStorage.getItem('token');

      try {
        const res = await fetch(`${API_BASE}/profile/name`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": token
          },
          body: JSON.stringify({ newName }),
        });

        const data = await res.json();

        if (res.ok) {
          showToast(data.message);
          // Update local storage and UI
          let userProfile = JSON.parse(localStorage.getItem('userProfile'));
          userProfile.name = data.name;
          userProfile.nameChangeCount = data.nameChangeCount; // Update nameChangeCount
          userProfile.lastChangeTimestamp = data.lastChangeTimestamp; // Update lastChangeTimestamp
          localStorage.setItem('userProfile', JSON.stringify(userProfile));
          console.log("userProfile after update and before loadProfile:", userProfile); // Debug log
          loadProfile(); // Reload profile to update name and info
          closeEditNameModal();
          closeNameConfirmModal(); // Close confirmation modal
        } else {
          showToast(data.message || "Failed to update name.", 'error');
          closeNameConfirmModal(); // Close confirmation modal on error
        }
      } catch (error) {
        console.error("Edit name error:", error);
        showToast("An error occurred while updating name.", 'error');
        closeNameConfirmModal(); // Close confirmation modal on error
      }
    }

    // Event listeners for confirmation buttons
    document.getElementById('confirmNameChangeBtn').addEventListener('click', confirmNameChange);
    document.getElementById('cancelNameChangeBtn').addEventListener('click', closeNameConfirmModal);
  </script>

  <!-- View All Stories Modal -->
  <div id="viewAllStoriesModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeViewAllStoriesModal()">&times;</span>
      <h2>All My Stories</h2>
      <div id="allMyStoriesContainer" class="stories-grid">
        <!-- All user stories will be rendered here -->
      </div>
    </div>
  </div>

  <!-- View All Drafts Modal -->
  <div id="viewAllDraftsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeViewAllDraftsModal()">&times;</span>
      <h2>All My Drafts</h2>
      <div id="allMyDraftsContainer" class="stories-grid">
        <!-- All user drafts will be rendered here -->
      </div>
    </div>
  </div>

  <!-- Comment Modal -->
  <div id="commentModal" class="modal">
    <div class="modal-content modal-top-layer">
      <span class="close-modal" id="closeCommentModal">&times;</span>
      <h2>Comments</h2>
      <div class="comment-input-section">
        <textarea id="commentInput" placeholder="Write your comment..."></textarea>
        <button id="submitCommentBtn" class="auth-btn">Submit Comment</button>
      </div>
      <div class="comments-list" id="commentsList">
        <!-- Comments will be loaded here -->
      </div>
    </div>
  </div>

  <div id="customToast"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const authBtn = document.getElementById("openAuthBtn");
  const authModal = document.getElementById("authModal"); // your login/register modal
  const closeBtn = document.querySelector(".close-modal");

  if (authBtn && authModal) {
    authBtn.addEventListener("click", () => {
      authModal.style.display = "block";
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      authModal.style.display = "none";
    });
  }

  // Close modal when clicking outside of content
  window.addEventListener("click", (event) => {
    if (event.target === authModal) {
      authModal.style.display = "none";
    }
  });
});
</script>
</body>
</html>